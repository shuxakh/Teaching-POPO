<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teaching POPO ‚Äî AI Hints</title>
  <style>
    body{font-family:system-ui;margin:24px;background:#fafbff}
    .wrap{max-width:1200px;margin:0 auto}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;cursor:pointer}
    .card{background:#fff;padding:14px;border:1px solid #ddd;border-radius:12px;margin-bottom:12px}
    .live{background:#f5f6fb;border:1px solid #ddd;border-radius:10px;min-height:70px;padding:10px}
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:800px){.twocol{grid-template-columns:1fr}}
    .feed{display:flex;flex-direction:column;gap:12px}
    .entry{background:#fff;border:1px solid #ddd;border-radius:12px;padding:10px}
    .cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media(max-width:800px){.cols{grid-template-columns:1fr}}
    .col{border:1px solid #ddd;border-radius:10px;padding:8px}
    .error{background:#ffe9d6;border-color:#ffb980}
    .def{background:#efe7ff;border-color:#c9b6ff}
    .syn{background:#e8f7e8;border-color:#b8e6b8}
    .errItem,.defItem,.synItem{margin:6px 0;padding:6px;border-radius:8px}
    .errItem{background:#fff0e5;border:1px solid #ffc58a}
    .defItem{background:#f5f0ff;border:1px solid #c9b6ff}
    .synItem{background:#f0fff0;border:1px solid #b8e6b8}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Teacher Panel ‚Äî Private AI Hints</h1>

  <div class="card">
    <div class="row">
      <button id="micBtn">üéôÔ∏è Teacher Mic</button>
      <button id="stopTeacher" disabled>‚èπÔ∏è</button>
      <button id="tabBtn">üñ•Ô∏è Student Tab</button>
      <button id="stopStudent" disabled>‚èπÔ∏è</button>
    </div>
    <p style="font-size:.9rem;color:#555">–í—ã–±–µ—Ä–∏ –≤–∫–ª–∞–¥–∫—É –∏ –≤–∫–ª—é—á–∏ ‚ÄúShare tab audio‚Äù. –ï—Å–ª–∏ –∞—É–¥–∏–æ –Ω–µ—Ç ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.</p>
  </div>

  <div class="twocol">
    <div><h3>Teacher transcript</h3><div id="teacherOut" class="live">‚Äî</div></div>
    <div><h3>Student transcript</h3><div id="studentOut" class="live">‚Äî</div></div>
  </div>

  <h3>AI hints (newest on top)</h3>
  <div id="feed" class="feed"></div>

  <p>Status: <span id="status">idle</span></p>
</div>

<script>
let SR, keepTeacher=false, tFull="",sFull="",tLast="",sLast="";
let mediaRec=null, tabStream=null;
const CHUNK_MS=1500;
const teacherOut=document.getElementById('teacherOut');
const studentOut=document.getElementById('studentOut');
const feed=document.getElementById('feed');
const statusEl=document.getElementById('status');

function tail(t,n=15){return(t||"").trim().split(/\s+/).slice(-n).join(" ").toLowerCase();}
function supportsSR(){return'webkitSpeechRecognition'in window||'SpeechRecognition'in window;}

function pickMime(){
  const m=['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
  for(const x of m){if(MediaRecorder.isTypeSupported?.(x))return x;}
  return '';
}

// ========== TEACHER ==========
function initSR(){
  const S=window.SpeechRecognition||window.webkitSpeechRecognition;
  SR=new S();SR.lang='en-US';SR.interimResults=true;SR.continuous=true;
  SR.onresult=async e=>{
    let interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i];
      if(r.isFinal){
        const piece=r[0].transcript.trim();if(!piece)continue;
        tFull+=(tFull?' ':'')+piece;teacherOut.textContent=tFull;
        const t=tail(tFull);if(t&&t!==tLast){tLast=t;requestHints();}
      }else interim+=r[0].transcript;
    }
    if(interim)teacherOut.textContent=(tFull+' '+interim).trim();
  };
}
async function startTeacher(){
  if(!supportsSR()){alert('Update Chrome.');return;}
  if(!SR)initSR();
  tFull="";tLast="";
  try{await navigator.mediaDevices.getUserMedia({audio:true});}catch{}
  keepTeacher=true;SR.start();
  document.getElementById('micBtn').disabled=true;
  document.getElementById('stopTeacher').disabled=false;
  statusEl.textContent='listening teacher';
}
function stopTeacher(){
  keepTeacher=false;try{SR.stop();}catch{}
  document.getElementById('micBtn').disabled=false;
  document.getElementById('stopTeacher').disabled=true;
  statusEl.textContent='idle';
}

// ========== STUDENT ==========
async function startStudent(){
  try{tabStream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});}
  catch{alert('Cancelled');return;}
  const aTracks=tabStream.getAudioTracks();
  if(!aTracks||aTracks.length===0){
    alert('–ù–µ—Ç –∞—É–¥–∏–æ! –í—ã–±–µ—Ä–∏ Chrome Tab –∏ –≤–∫–ª—é—á–∏ "Share tab audio".');
    tabStream.getTracks().forEach(t=>t.stop());tabStream=null;return;
  }
  tabStream.getVideoTracks().forEach(tr=>tr.addEventListener('ended',()=>stopStudent()));
  sFull="";sLast="";
  studentOut.textContent="Capturing Student Tab‚Ä¶";
  const mime=pickMime();
  try{mediaRec=new MediaRecorder(tabStream,mime?{mimeType:mime}:{})}
  catch(e){alert('Recorder init fail '+e);stopStudent();return;}
  mediaRec.ondataavailable=async ev=>{
    if(!ev.data||ev.data.size<1000)return;
    const buf=await ev.data.arrayBuffer();
    const b64=arrayBufferToBase64(buf);
    const r=await fetch('/api/stt_student',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({audioBase64:b64})});
    const d=await r.json();const text=(d.text||'').trim();
    if(text){sFull+=(sFull?' ':'')+text;studentOut.textContent=sFull;
      const t=tail(sFull);if(t&&t!==sLast){sLast=t;requestHints();}}
  };
  mediaRec.onerror=e=>console.warn('recorder err',e);
  try{mediaRec.start(CHUNK_MS);}catch(e){alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å');stopStudent();return;}
  document.getElementById('tabBtn').disabled=true;
  document.getElementById('stopStudent').disabled=false;
  statusEl.textContent='listening student';
}
function stopStudent(){
  try{mediaRec&&mediaRec.state!=='inactive'&&mediaRec.stop();}catch{}
  mediaRec=null;
  if(tabStream){try{tabStream.getTracks().forEach(t=>t.stop());}catch{}tabStream=null;}
  document.getElementById('tabBtn').disabled=false;
  document.getElementById('stopStudent').disabled=true;
  statusEl.textContent='idle';
}

function arrayBufferToBase64(b){let bin='',bytes=new Uint8Array(b);for(let i=0;i<bytes.length;i++)bin+=String.fromCharCode(bytes[i]);return btoa(bin);}

// ========== AI HINTS ==========
let busy=false;
async function requestHints(){
  if(busy)return;busy=true;
  try{
    const r=await fetch('/api/hints',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({teacher:tFull,student:sFull})});
    const d=await r.json();if(d.card)prependCard(d.card);
  }catch(e){console.warn(e);}busy=false;
}

function prependCard(card){
  const div=document.createElement('div');div.className='entry';
  div.innerHTML=`<div class="cols">
  <div class="col error"><h4>Errors & Fix</h4><div class="errors"></div></div>
  <div class="col def"><h4>Definitions</h4><div class="defs"></div></div>
  <div class="col syn"><h4>Synonyms</h4><div class="syns"></div></div></div>`;
  const eW=div.querySelector('.errors'),dW=div.querySelector('.defs'),sW=div.querySelector('.syns');
  (card.errors||[]).forEach(e=>{
    const el=document.createElement('div');el.className='errItem';
    el.innerHTML=`<b>${e.title||'Mistake'}</b><br>‚ùå ${e.wrong||''}<br>‚úÖ ${e.fix||''}<div>${e.explanation||''}</div>`;eW.appendChild(el);});
  (card.definitions||[]).forEach(x=>{
    const el=document.createElement('div');el.className='defItem';
    el.innerHTML=`<b>${x.word}</b> (${x.pos}) ‚Äî ${x.simple_def}`;dW.appendChild(el);});
  (card.synonyms||[]).forEach(x=>{
    const el=document.createElement('div');el.className='synItem';
    el.innerHTML=`<b>${x.word}</b> (${x.pos}) ‚Üí ${(x.list||[]).join(', ')}`;sW.appendChild(el);});
  feed.prepend(div);while(feed.children.length>30)feed.removeChild(feed.lastChild);
}

document.getElementById('micBtn').onclick=startTeacher;
document.getElementById('stopTeacher').onclick=stopTeacher;
document.getElementById('tabBtn').onclick=startStudent;
document.getElementById('stopStudent').onclick=stopStudent;
</script>
</body>
</html>
