<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Teacher ‚Äî AI Hints (Private)</title>
  <style>
    :root{
      --card:#fff;
      --border:#e6e7ef;
      --muted:#666;
      --error-bg:#ffe9d6;
      --error-border:#ffb980;
      --col-gap:12px;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; background:#fafbff;}
    .wrap { max-width: 1100px; margin: 0 auto; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .card { border:1px solid var(--border); border-radius:14px; padding:14px; background:var(--card); margin-bottom:12px; }
    .live { background:#f6f7fb; padding:12px; border-radius:12px; min-height:70px; border:1px solid var(--border); }
    button { padding:10px 14px; border-radius:10px; border:1px solid #d0d3db; background:#fff; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .note { color:var(--muted); font-size: 0.95rem; }
    .ok { color: #1b5e20; }
    .warn { color: #b71c1c; }

    /* FEED: –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–≤–µ—Ä—Ö—É (prepend) */
    .feed { display:flex; flex-direction: column; gap: 12px; }
    .entry { border:1px solid var(--border); border-radius:14px; padding:12px; background:#fff; }
    .cols { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--col-gap); }
    .col { border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
    .col h4 { margin:0 0 8px 0; }
    .error { background:var(--error-bg); border-color: var(--error-border); }

    .errItem { background:var(--error-bg); border:1px solid var(--error-border); border-radius:10px; padding:10px; margin:8px 0; }
    .errTitle { font-weight:700; color:#b45309; }
    .wrong { margin-top:6px; }
    .fix { font-weight:700; margin-top:4px; }
    .ex { color:#444; margin-top:4px; }

    .defItem, .synItem { background:#f9fafb; border:1px solid var(--border); border-radius:10px; padding:10px; margin:8px 0; }
    .word { font-weight:700; }

    @media (max-width: 900px) { .cols { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Teacher Panel ‚Äî Private AI Hints</h1>
    <p class="note">Chrome only. Choose audio source ‚Üí start ‚Üí AI will show brief, structured hints only here.</p>

    <div class="card">
      <div class="row">
        <label>Audio source:</label>
        <button id="micBtn">üéôÔ∏è Microphone</button>
        <button id="tabBtn">üñ•Ô∏è Capture a Chrome Tab (with audio)</button>
        <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
      </div>
      <p class="note">
        <b>Capture Tab:</b> –≤—ã–±–µ—Ä–∏ –≤–∫–ª–∞–¥–∫—É –∏ –æ—Ç–º–µ—Ç—å ‚ÄúShare tab audio‚Äù. –ë—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —á–∏—Ç–∞—Ç—å —ç—Ç–æ—Ç –ø–æ—Ç–æ–∫,
        –ø–æ—ç—Ç–æ–º—É –º—ã **–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –≤–∫–ª–∞–¥–∫–∏ —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏–∫–∏**, –∞ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–∏).
        –î–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π Whisper.
      </p>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –±–µ–∑ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ -->
    <div class="card">
      <h3>Quick test (no mic)</h3>
      <div class="row">
        <input id="manualText" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:10px" placeholder="Type a sentence here...">
        <button id="sendManual">Send</button>
      </div>
      <p class="note">–ù—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å AI, –¥–∞–∂–µ –µ—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω.</p>
    </div>

    <h3>Live transcript</h3>
    <div id="transcript" class="live">‚Äî</div>

    <h3>AI hints for teacher (newest on top)</h3>
    <div id="feed" class="feed"></div>

    <p class="note">Status: <span id="status">stopped</span></p>
  </div>

  <script>
    // DOM
    const statusEl = document.getElementById('status');
    const out = document.getElementById('transcript');
    const feed = document.getElementById('feed');
    const micBtn = document.getElementById('micBtn');
    const tabBtn = document.getElementById('tabBtn');
    const stopBtn = document.getElementById('stopBtn');

    // State
    let recog = null;
    let keepListening = false;
    let fullText = "";
    let lastSentTail = "";
    let pingTimer = null;
    let tabAudioEl = null;   // –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –≤–∫–ª–∞–¥–∫–∏

    // Helpers
    function supportsSR() {
      return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
    }
    function tail(text, maxWords=25){
      const words = (text||"").trim().split(/\s+/);
      return words.slice(-maxWords).join(" ").toLowerCase();
    }
    function startUI(mode){
      micBtn.disabled = true;
      tabBtn.disabled = true;
      stopBtn.disabled = false;
      statusEl.textContent = `listening (${mode})`;
      statusEl.className = "ok";
      if (!pingTimer) pingTimer = setInterval(() => { fetch('/api/health').catch(()=>{}); }, 20000);
    }
    function stopUI(){
      stopBtn.disabled = true;
      micBtn.disabled = false;
      tabBtn.disabled = false;
      statusEl.textContent = "stopped";
      statusEl.className = "";
      if (pingTimer) { clearInterval(pingTimer); pingTimer = null; }
    }

    // SpeechRecognition
    function initRecog(lang='en-US') {
      if (!supportsSR()) {
        alert("Your Chrome does not expose SpeechRecognition API. Please update Chrome.");
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recog = new SR();
      recog.lang = lang;
      recog.interimResults = true;
      recog.continuous = true;

      recog.onresult = async (e) => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const r = e.results[i];
          if (r.isFinal) {
            const piece = r[0].transcript.trim();
            if (!piece) continue;
            fullText += (fullText ? ' ' : '') + piece;
            out.textContent = fullText;

            const t = tail(fullText, 25);
            if (t && t !== lastSentTail) {
              lastSentTail = t;
              try {
                const resp = await fetch('/api/hints', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ text: fullText })
                });
                const data = await resp.json();
                if (data && data.card) prependCard(data.card);
              } catch (e) { console.warn('Hints error', e); }
            }
          } else {
            interim += r[0].transcript;
          }
        }
        if (interim) out.textContent = (fullText + ' ' + interim).trim();
      };

      recog.onerror = (e) => {
        console.warn('SpeechRecognition error', e);
        statusEl.textContent = "error (speech)";
        statusEl.className = "warn";
      };

      recog.onend = () => {
        if (keepListening) {
          try { recog.start(); } catch {}
        } else {
          stopUI();
        }
      };
    }

    // UI actions
    async function startMic(){
      if (!recog) initRecog('en-US');
      fullText = ""; lastSentTail = "";
      out.textContent = "Listening via Microphone‚Ä¶";
      keepListening = true;
      startUI('mic');
      try { await navigator.mediaDevices.getUserMedia({ audio: true }); } catch {}
      try { recog.start(); } catch {}
    }

    async function startTabCapture(){
      if (!recog) initRecog('en-US');
      fullText = ""; lastSentTail = "";
      out.textContent = "Listening to captured tab‚Ä¶ (make sure system volume is audible)";
      keepListening = true;
      startUI('tab');

      // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É —Å –∞—É–¥–∏–æ –∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –µ—ë —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏–∫–∏,
      // —á—Ç–æ–±—ã –º–∏–∫—Ä–æ—Ñ–æ–Ω ‚Äú—Å–ª—ã—à–∞–ª‚Äù –∑–≤—É–∫ –≤–∫–ª–∞–¥–∫–∏ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Web Speech API).
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        // —Å–æ–∑–¥–∞—ë–º –∞—É–¥–∏–æ-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ –∑–≤—É–∫–∞
        if (tabAudioEl) { try { tabAudioEl.pause(); } catch{} }
        tabAudioEl = new Audio();
        tabAudioEl.srcObject = stream;
        tabAudioEl.muted = false;   // –í–ö–õ–Æ–ß–ê–ï–ú –∑–≤—É–∫ –∑–∞—Ö–≤–∞—á–µ–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –Ω–∞—Ä—É–∂—É
        tabAudioEl.play().catch(()=>{});
      } catch (e) {
        alert('Tab capture was cancelled. You can use Microphone option instead.');
        stopAll();
        return;
      }

      try { recog.start(); } catch {}
    }

    function stopAll(){
      keepListening = false;
      try { recog && recog.stop(); } catch {}
      if (tabAudioEl) { try { tabAudioEl.pause(); } catch{} tabAudioEl = null; }
      stopUI();
    }

    function prependCard(card){
      const entry = document.createElement('div');
      entry.className = 'entry';
      entry.innerHTML = `
        <div class="cols">
          <div class="col error">
            <h4>Errors & Fix</h4>
            <div class="list errors"></div>
          </div>
          <div class="col def">
            <h4>Definitions</h4>
            <div class="list defs"></div>
          </div>
          <div class="col syn">
            <h4>Synonyms</h4>
            <div class="list syns"></div>
          </div>
        </div>
      `;

      const errsWrap = entry.querySelector('.errors');
      (card.errors || []).forEach(e => {
        const div = document.createElement('div');
        div.className = 'errItem';
        div.innerHTML = `
          <div class="errTitle">${e.title || 'Mistake'}</div>
          ${e.wrong ? `<div class="wrong">‚ùå ${e.wrong}</div>` : ''}
          ${e.fix ? `<div class="fix">‚úÖ ${e.fix}</div>` : ''}
          ${e.explanation ? `<div class="ex">${e.explanation}</div>` : ''}
        `;
        errsWrap.appendChild(div);
      });

      const defsWrap = entry.querySelector('.defs');
      (card.definitions || []).forEach(d => {
        const div = document.createElement('div');
        div.className = 'defItem';
        div.innerHTML = `<div class="word">${d.word || ''} (${d.pos || ''})</div>
                         <div>${d.simple_def || ''}</div>`;
        defsWrap.appendChild(div);
      });

      const synsWrap = entry.querySelector('.syns');
      (card.synonyms || []).forEach(s => {
        const div = document.createElement('div');
        div.className = 'synItem';
        const list = (s.list || []).join(', ');
        div.innerHTML = `<div class="word">${s.word || ''} (${s.pos || ''})</div>
                         <div>${list}</div>`;
        synsWrap.appendChild(div);
      });

      feed.prepend(entry);
      const max = 20;
      while (feed.children.length > max) feed.removeChild(feed.lastChild);
    }

    // Bind
    document.addEventListener('DOMContentLoaded', () => {
      micBtn.disabled = false;
      tabBtn.disabled = false;
      micBtn.onclick = startMic;
      tabBtn.onclick = startTabCapture;
      stopBtn.onclick = stopAll;

      // Quick test (manual)
      const manualBtn = document.getElementById('sendManual');
      manualBtn.onclick = async () => {
        const t = document.getElementById('manualText').value.trim();
        if (!t) return;
        fullText = fullText ? (fullText + ' ' + t) : t;
        out.textContent = fullText;
        lastSentTail = tail(fullText, 25);
        try {
          const resp = await fetch('/api/hints', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ text: fullText })
          });
          const data = await resp.json();
          if (data && data.card) prependCard(data.card);
        } catch(e){ console.warn(e); }
      };
    });
  </script>
</body>
</html>
