<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Teacher ‚Äî AI Hints (Private)</title>
  <style>
    :root{
      --card:#fff;
      --border:#e6e7ef;
      --muted:#666;
      --hint-bg:#fff8e1;
      --hint-border:#ffe082;
      --error-bg:#ffe9d6;
      --error-border:#ffb980;
      --col-gap:12px;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; background:#fafbff;}
    .wrap { max-width: 1100px; margin: 0 auto; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .card { border:1px solid var(--border); border-radius:14px; padding:14px; background:var(--card); margin-bottom:12px; }
    .live { background:#f6f7fb; padding:12px; border-radius:12px; min-height:70px; border:1px solid var(--border); }
    button { padding:10px 14px; border-radius:10px; border:1px solid #d0d3db; background:#fff; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .note { color:var(--muted); font-size: 0.95rem; }
    .ok { color: #1b5e20; }
    .warn { color: #b71c1c; }

    /* feed */
    .feed { display:flex; flex-direction: column-reverse; gap: 12px; } /* –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É: –º—ã –±—É–¥–µ–º prepend */
    .entry { border:1px solid var(--border); border-radius:14px; padding:12px; background:#fff; }
    .cols { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--col-gap); }
    .col { border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
    .col h4 { margin:0 0 8px 0; }
    .error { background:var(--error-bg); border-color: var(--error-border); }
    .def  { }
    .syn  { }

    .errItem { background:var(--error-bg); border:1px solid var(--error-border); border-radius:10px; padding:10px; margin:8px 0; }
    .errTitle { font-weight:700; color:#b45309; }
    .wrong { margin-top:6px; }
    .fix { font-weight:700; margin-top:4px; }
    .ex { color:#444; margin-top:4px; }

    .defItem, .synItem { background:#f9fafb; border:1px solid var(--border); border-radius:10px; padding:10px; margin:8px 0; }
    .word { font-weight:700; }

    @media (max-width: 900px) {
      .cols { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Teacher Panel ‚Äî Private AI Hints</h1>
    <p class="note">Chrome only. Choose audio source ‚Üí start ‚Üí AI will show brief, structured hints only here.</p>

    <div class="card">
      <div class="row">
        <label>Audio source:</label>
        <button id="micBtn">üéôÔ∏è Microphone</button>
        <button id="tabBtn" disabled title="(–≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ SR –Ω–µ —á–∏—Ç–∞–µ—Ç –∑–≤—É–∫ –≤–∫–ª–∞–¥–∫–∏ –Ω–∞–ø—Ä—è–º—É—é)">üîä Capture a Chrome Tab</button>
        <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
      </div>
      <p class="note">
        *–î–ª—è –ª—É—á—à–µ–π —Ä–∞–∑–¥–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ <b>–æ–¥–∏–Ω</b> –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω (–Ω–∞—É—à–Ω–∏–∫–∏ —É—á–∏—Ç–µ–ª—é, —á—Ç–æ–±—ã –µ–≥–æ –≥–æ–ª–æ—Å –Ω–µ –ø–æ–ø–∞–¥–∞–ª –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω).  
        –û—Ç–¥–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π STT –ø–æ–¥–∫–ª—é—á–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ (Whisper).
      </p>
    </div>

    <h3>Live transcript</h3>
    <div id="transcript" class="live">‚Äî</div>

    <h3>AI hints for teacher (newest on top)</h3>
    <div id="feed" class="feed"></div>

    <p class="note">Status: <span id="status">idle</span></p>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const out = document.getElementById('transcript');
    const feed = document.getElementById('feed');
    const micBtn = document.getElementById('micBtn');
    const tabBtn = document.getElementById('tabBtn');
    const stopBtn = document.getElementById('stopBtn');

    let recog = null;
    let running = false;
    let fullText = "";

    function supportsSR() {
      return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
    }
    if (!supportsSR()) {
      alert("Your Chrome does not expose SpeechRecognition API. Please update Chrome.");
    }

    function initRecog(lang='en-US') {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recog = new SR();
      recog.lang = lang;
      recog.interimResults = true;
      recog.continuous = true;

      recog.onresult = async (e) => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const r = e.results[i];
          if (r.isFinal) {
            fullText += (fullText ? ' ' : '') + r[0].transcript.trim();
            out.textContent = fullText;

            // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏–ª–æ—Å—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
            try {
              const resp = await fetch('/api/hints', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: fullText })
              });
              const data = await resp.json();
              if (data && data.card) prependCard(data.card);
            } catch (e) { console.warn('Hints error', e); }
          } else {
            interim += r[0].transcript;
          }
        }
        if (interim) out.textContent = (fullText + ' ' + interim).trim();
      };

      recog.onerror = (e) => {
        console.warn('SpeechRecognition error', e);
        statusEl.textContent = "error (speech)";
        statusEl.className = "warn";
      };

      recog.onend = () => {
        running = false;
        stopBtn.disabled = true;
        micBtn.disabled = false;
        statusEl.textContent = "stopped";
        statusEl.className = "";
      };
    }

    function prependCard(card){
      // —Å–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç–æ—á–∫—É —Å 3 –∫–æ–ª–æ–Ω–∫–∞–º–∏
      const entry = document.createElement('div');
      entry.className = 'entry';
      entry.innerHTML = `
        <div class="cols">
          <div class="col error">
            <h4>Errors & Fix</h4>
            <div class="list errors"></div>
          </div>
          <div class="col def">
            <h4>Definitions</h4>
            <div class="list defs"></div>
          </div>
          <div class="col syn">
            <h4>Synonyms</h4>
            <div class="list syns"></div>
          </div>
        </div>
      `;

      const errsWrap = entry.querySelector('.errors');
      (card.errors || []).forEach(e => {
        const div = document.createElement('div');
        div.className = 'errItem';
        div.innerHTML = `
          <div class="errTitle">${e.title || 'Mistake'}</div>
          ${e.wrong ? `<div class="wrong">‚ùå ${e.wrong}</div>` : ''}
          ${e.fix ? `<div class="fix">‚úÖ ${e.fix}</div>` : ''}
          ${e.explanation ? `<div class="ex">${e.explanation}</div>` : ''}
        `;
        errsWrap.appendChild(div);
      });

      const defsWrap = entry.querySelector('.defs');
      (card.definitions || []).forEach(d => {
        const div = document.createElement('div');
        div.className = 'defItem';
        div.innerHTML = `<div class="word">${d.word || ''} (${d.pos || ''})</div>
                         <div>${d.simple_def || ''}</div>`;
        defsWrap.appendChild(div);
      });

      const synsWrap = entry.querySelector('.syns');
      (card.synonyms || []).forEach(s => {
        const div = document.createElement('div');
        div.className = 'synItem';
        const list = (s.list || []).join(', ');
        div.innerHTML = `<div class="word">${s.word || ''} (${s.pos || ''})</div>
                         <div>${list}</div>`;
        synsWrap.appendChild(div);
      });

      // –µ—Å–ª–∏ —Å–µ–∫—Ü–∏—è –ø—É—Å—Ç–∞—è ‚Äî –ø—Ä—è—á–µ–º –∫–æ–ª–æ–Ω–∫—É
      if (!(card.errors || []).length) entry.querySelector('.error').style.display='none';
      if (!(card.definitions || []).length) entry.querySelector('.def').style.display='none';
      if (!(card.synonyms || []).length) entry.querySelector('.syn').style.display='none';

      // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –ª–µ–Ω—Ç—ã (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
      feed.prepend(entry);

      // –æ–≥—Ä–∞–Ω–∏—á–∏–º –∏—Å—Ç–æ—Ä–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, 20 –∫–∞—Ä—Ç–æ—á–µ–∫
      const max = 20;
      while (feed.children.length > max) feed.removeChild(feed.lastChild);
    }

    async function startMic() {
      if (!supportsSR()) return alert('Update Chrome.');
      if (!recog) initRecog('en-US');
      fullText = "";
      out.textContent = "Listening via Microphone‚Ä¶";
      micBtn.disabled = true;
      stopBtn.disabled = false;
      statusEl.textContent = "listening (mic)";
      statusEl.className = "ok";
      try { await navigator.mediaDevices.getUserMedia({ audio: true }); } catch {}
      recog.start();
    }

    function stopAll() {
      if (recog && running) { try { recog.stop(); } catch {} }
      running = false;
      stopBtn.disabled = true;
      micBtn.disabled = false;
      statusEl.textContent = "stopped";
      statusEl.className = "";
    }

    micBtn.onclick = () => { running = true; startMic(); };
    stopBtn.onclick = stopAll;
  </script>
</body>
</html>
