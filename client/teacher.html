<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teacher ‚Äî AI Hints (WAV student)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px;background:#fafbff}
    .wrap{max-width:1200px;margin:0 auto}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .card{background:#fff;padding:14px;border:1px solid #ddd;border-radius:12px;margin-bottom:12px}
    .live{background:#f5f6fb;border:1px solid #ddd;border-radius:10px;min-height:70px;padding:10px}
    .topgrid{display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start}
    @media(max-width:900px){.topgrid{grid-template-columns:1fr}}
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.twocol{grid-template-columns:1fr}}
    .feed{display:flex;flex-direction:column;gap:12px}
    .entry{background:#fff;border:1px solid #ddd;border-radius:12px;padding:10px}
    .cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media(max-width:900px){.cols{grid-template-columns:1fr}}
    .col{border:1px solid #ddd;border-radius:10px;padding:8px}
    .error{background:#ffe9d6;border-color:#ffb980}
    .def{background:#efe7ff;border-color:#c9b6ff}
    .syn{background:#e8f7e8;border-color:#b8e6b8}
    .errItem,.defItem,.synItem{margin:6px 0;padding:6px;border-radius:8px}
    .errItem{background:#fff0e5;border:1px solid #ffc58a}
    .defItem{background:#f5f0ff;border:1px solid #c9b6ff}
    .synItem{background:#f0fff0;border:1px solid #b8e6b8}
    .note{color:#666;font-size:.9rem}
    .diag{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1020;color:#d9e1ff;border-radius:12px;border:1px solid #263056;padding:12px;line-height:1.35;overflow:auto;position:relative}
    .ok{color:#9cff9c}.bad{color:#ff9c9c}.warn{color:#ffd27a}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #445}
    .ghost{position:absolute;right:8px;top:8px;opacity:.3}
    .diag:hover .ghost{opacity:1}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Teacher Panel ‚Äî Private AI Hints</h1>

  <div class="topgrid">
    <div class="card">
      <div class="row">
        <label><b>Teacher:</b></label>
        <button id="micBtn">üéôÔ∏è Teacher Mic</button>
        <button id="stopTeacher" disabled>‚èπÔ∏è Stop</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label><b>Student:</b></label>
        <button id="tabBtn">üñ•Ô∏è Student Tab (with audio)</button>
        <button id="stopStudent" disabled>‚èπÔ∏è Stop</button>
      </div>
      <p class="note" style="margin-top:6px">
        –í –¥–∏–∞–ª–æ–≥–µ Chrome –≤—ã–±–µ—Ä–∏ <b>Chrome Tab</b> –∏ –≤–∫–ª—é—á–∏ <b>Share tab audio</b>.
      </p>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Quick test</h3>
      <div class="row" style="gap:8px">
        <input id="manualText" placeholder="Type a word or phrase‚Ä¶" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:10px">
        <button id="sendManual">Send</button>
      </div>
      <p class="note" style="margin-top:8px">–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —É—á–∏—Ç–µ–ª—è.</p>
    </div>
  </div>

  <div class="twocol">
    <div>
      <h3>Teacher transcript</h3>
      <div id="teacherOut" class="live">‚Äî</div>
    </div>
    <div>
      <h3>Student transcript</h3>
      <div id="studentOut" class="live">‚Äî</div>
    </div>
  </div>

  <h3 style="margin-top:16px">AI hints (newest on top)</h3>
  <div id="feed" class="feed"></div>

  <h3 style="margin-top:16px">Diagnostics</h3>
  <div id="diag" class="diag">
    idle
    <button id="forceFlush" class="ghost">Force flush</button>
  </div>

  <p class="note" style="margin-top:8px">Status: <span id="status">idle</span></p>
</div>

<script>
/*** ------------ –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ------------ ***/
let SR, keepTeacher=false, tFull="", sFull="", tLast="", sLast="";
let displayStream=null, srcStream=null;
let audioCtx=null, sourceNode=null, splitter=null, merger=null, gainNode=null, scriptNode=null, analyser=null;
let sampleRate=48000;

const statusEl=document.getElementById('status');
const teacherOut=document.getElementById('teacherOut');
const studentOut=document.getElementById('studentOut');
const feed=document.getElementById('feed');
const diagEl=document.getElementById('diag');

const SEND_MS = 2000;           // –∫–∞–∂–¥—ã–µ 2—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º WAV-—Ñ—Ä–∞–≥–º–µ–Ω—Ç
const PAUSE_MS = 4000;          // –æ—á–∏—Å—Ç–∫–∞ live transcript –ø–æ—Å–ª–µ –ø–∞—É–∑—ã
let sPauseTimer=null;

// –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å PCM
let pcmBuffers=[]; // –º–∞—Å—Å–∏–≤ Float32Arrays
let pcmLen=0;
let sendTimer=null;
let sttBusy=false;
let flushes=0, lastFlushAt='‚Äî', rms=0;

function now(){ return new Date().toLocaleTimeString(); }
function tail(t,n=15){return (t||"").trim().split(/\s+/).slice(-n).join(" ").toLowerCase();}
function updateDiag(extra={}) {
  diagEl.innerHTML = `
time: ${now()}<br>
mode: WAV/PCM  ‚Ä¢ sampleRate: ${sampleRate} ‚Ä¢ flushes: ${flushes} ‚Ä¢ sttBusy: ${sttBusy} ‚Ä¢ lastFlushAt: ${lastFlushAt}<br>
pcmLen(samples): ${pcmLen} ‚Ä¢ level(RMS): ${rms.toFixed(3)} ‚Ä¢ boost: x${(gainNode?.gain?.value||1).toFixed(1)}<br>
${extra.msg?('<span class="warn">'+extra.msg+'</span>'):''}
<button id="forceFlush" class="ghost">Force flush</button>
`;
  document.getElementById('forceFlush').onclick = () => flushWav(true);
}

/*** ------------ Teacher (SpeechRecognition) ------------ ***/
function supportsSR(){return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;}
function initSR(){
  const S=window.SpeechRecognition||window.webkitSpeechRecognition;
  SR=new S(); SR.lang='en-US'; SR.interimResults=true; SR.continuous=true;
  SR.onresult=e=>{
    let interim=''; for(let i=e.resultIndex;i<e.results.length;i++){ const r=e.results[i];
      if(r.isFinal){ const piece=r[0].transcript.trim(); if(!piece) continue;
        tFull+=(tFull?' ':'')+piece; teacherOut.textContent=tFull;
        const tt=tail(tFull); if(tt && tt!==tLast){ tLast=tt; requestHints(); }
        clearTimeout(tPauseTimer); tPauseTimer=setTimeout(()=>{ tFull=""; tLast=""; teacherOut.textContent="‚Äî"; }, PAUSE_MS);
      }else{ interim+=r[0].transcript; }
    }
    if(interim) teacherOut.textContent=(tFull+' '+interim).trim();
  };
  SR.onerror=()=>{}; SR.onend=()=>{ if(keepTeacher){ try{ SR.start(); }catch{} } };
}
let tPauseTimer=null;
async function startTeacher(){
  if(!supportsSR()){ alert('Update Chrome for SpeechRecognition API.'); return; }
  if(!SR) initSR(); try{ await navigator.mediaDevices.getUserMedia({audio:true}); }catch{}
  tFull=""; tLast=""; teacherOut.textContent="Listening (Teacher Mic)‚Ä¶";
  keepTeacher=true; SR.start(); document.getElementById('micBtn').disabled=true; document.getElementById('stopTeacher').disabled=false;
  statusEl.textContent='listening (teacher)';
}
function stopTeacher(){
  keepTeacher=false; try{ SR && SR.stop(); }catch{} document.getElementById('micBtn').disabled=false; document.getElementById('stopTeacher').disabled=true;
  if(!sendTimer) statusEl.textContent='idle';
}

/*** ------------ Student: –∑–∞—Ö–≤–∞—Ç –≤–∫–ª–∞–¥–∫–∏ ‚Üí –º–æ–Ω–æ ‚Üí WAV ------------ ***/
function floatTo16BitPCM(input) {
  const output = new Int16Array(input.length);
  for (let i=0;i<input.length;i++) {
    let s = Math.max(-1, Math.min(1, input[i]));
    output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
  }
  return output;
}

function encodeWAV(samples, sampleRate) {
  const buffer = new ArrayBuffer(44 + samples.length * 2);
  const view = new DataView(buffer);

  function writeString(offset, string) { for (let i=0;i<string.length;i++) view.setUint8(offset+i, string.charCodeAt(i)); }

  // RIFF header
  writeString(0, 'RIFF');
  view.setUint32(4, 36 + samples.length * 2, true);
  writeString(8, 'WAVE');
  writeString(12, 'fmt ');
  view.setUint32(16, 16, true);        // PCM
  view.setUint16(20, 1, true);         // PCM
  view.setUint16(22, 1, true);         // mono
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true); // byte rate
  view.setUint16(32, 2, true);         // block align
  view.setUint16(34, 16, true);        // bits per sample
  writeString(36, 'data');
  view.setUint32(40, samples.length * 2, true);

  const pcm16 = floatTo16BitPCM(samples);
  new Int16Array(buffer, 44).set(pcm16);
  return new Blob([buffer], { type: 'audio/wav' });
}

function mergeFloat32(buffers, totalLength) {
  const result = new Float32Array(totalLength);
  let offset = 0;
  for (const b of buffers) { result.set(b, offset); offset += b.length; }
  return result;
}

function startPCMCollector() {
  // –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã ‚Äî —Å–æ–±—Ä–∞—Ç—å —Ç–µ–∫—É—â–∏–π –±—É—Ñ–µ—Ä, –≤ WAV –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
  clearInterval(sendTimer);
  sendTimer = setInterval(() => flushWav(false), SEND_MS);
}

async function flushWav(manual=false) {
  if (sttBusy || pcmLen === 0) return;
  const samples = mergeFloat32(pcmBuffers, pcmLen);
  pcmBuffers = []; pcmLen = 0;

  const wavBlob = encodeWAV(samples, sampleRate);
  const buf = await wavBlob.arrayBuffer();
  const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));

  sttBusy = true; flushes++; lastFlushAt = now(); updateDiag({msg:`flush ${manual?'(manual)':''} size=${wavBlob.size}`});

  try{
    const resp = await fetch('/api/stt_student', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ audioBase64: b64, mime: 'audio/wav' })
    });

    if(!resp.ok){
      const txt = await resp.text().catch(()=> '');
      updateDiag({msg:`/api/stt_student ${resp.status} ${resp.statusText} ${txt.slice(0,200)}`});
    }else{
      const data = await resp.json().catch(()=> ({}));
      const text = (data?.text || '').trim();
      if(text){
        sFull += (sFull ? ' ' : '') + text;
        studentOut.textContent = sFull;
        const st = tail(sFull); if(st && st !== sLast){ sLast = st; requestHints(); }
        clearTimeout(sPauseTimer); sPauseTimer = setTimeout(()=>{ sFull=""; sLast=""; studentOut.textContent="‚Äî"; }, PAUSE_MS);
      }else{
        updateDiag({msg:'STT ok, but empty text'});
      }
    }
  }catch(e){
    updateDiag({msg:`upload error: ${e.message}`});
  }finally{
    sttBusy = false; updateDiag();
  }
}

async function startStudent(){
  try{
    displayStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
  }catch{ alert("–í—ã–±–æ—Ä –≤–∫–ª–∞–¥–∫–∏ –æ—Ç–º–µ–Ω—ë–Ω"); return; }

  const aTracks = displayStream.getAudioTracks();
  if(!aTracks || aTracks.length===0){
    alert('–ù–µ—Ç –∞—É–¥–∏–æ! –í–∫–ª—é—á–∏ "Share tab audio".');
    displayStream.getTracks().forEach(t=>t.stop());
    displayStream=null;
    return;
  }

  srcStream = new MediaStream([aTracks[0]]);

  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  sampleRate = audioCtx.sampleRate;

  sourceNode = audioCtx.createMediaStreamSource(srcStream);

  // –º–æ–Ω–æ: –±–µ—Ä—ë–º –ª–µ–≤—ã–π –∫–∞–Ω–∞–ª (–º–æ–∂–Ω–æ –º–∏–∫—Å–æ–≤–∞—Ç—å –æ–±–∞ ‚Äî –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –±–µ—Ä—ë–º –æ–¥–∏–Ω)
  splitter = audioCtx.createChannelSplitter(2);
  merger   = audioCtx.createChannelMerger(1);
  sourceNode.connect(splitter);
  splitter.connect(merger, 0, 0);

  gainNode = audioCtx.createGain();
  gainNode.gain.value = 3.0; // –Ω–µ–±–æ–ª—å—à–æ–π –±—É—Å—Ç

  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 512;

  // ScriptProcessor –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è PCM (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Chrome, –¥–∞, –æ–Ω deprecated, –Ω–æ —Å—Ç–∞–±–∏–ª–µ–Ω)
  const BUFFER_SIZE = 4096;
  scriptNode = audioCtx.createScriptProcessor(BUFFER_SIZE, 1, 1);
  scriptNode.onaudioprocess = (e) => {
    const ch = e.inputBuffer.getChannelData(0);
    // –∫–æ–ø–∏—Ä—É–µ–º, —Ç.–∫. e.inputBuffer –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    pcmBuffers.push(new Float32Array(ch));
    pcmLen += ch.length;

    // RMS –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    let sum=0; for(let i=0;i<ch.length;i++){ const v=ch[i]; sum+=v*v; }
    rms = Math.sqrt(sum/ch.length);
  };

  // —Ü–µ–ø–æ—á–∫–∞: mono ‚Üí gain ‚Üí analyser ‚Üí script (–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ)
  merger.connect(gainNode);
  gainNode.connect(analyser);
  gainNode.connect(scriptNode);
  scriptNode.connect(audioCtx.destination); // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫–æ–Ω–Ω–µ–∫—Ç–∏–º –≤ –≥—Ä–∞—Ñ (–∑–≤—É–∫ –º–æ–∂–Ω–æ –Ω–µ —Å–ª—ã—à–∞—Ç—å)

  // –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫—É –ø–µ—Ä–µ—Å—Ç–∞–ª–∏ —à–∞—Ä–∏—Ç—å ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏–º
  displayStream.getVideoTracks().forEach(tr => tr.addEventListener('ended', stopStudent));

  sFull=""; sLast=""; studentOut.textContent="Capturing Student Tab‚Ä¶";
  flushes=0; lastFlushAt='‚Äî'; sttBusy=false; pcmBuffers=[]; pcmLen=0;

  startPCMCollector();
  document.getElementById('tabBtn').disabled = true;
  document.getElementById('stopStudent').disabled = false;
  statusEl.textContent = keepTeacher ? 'listening (teacher + student)' : 'listening (student)';
  updateDiag();
}

function stopStudent(){
  clearInterval(sendTimer); sendTimer=null;

  try{ scriptNode && scriptNode.disconnect(); }catch{} scriptNode=null;
  try{ analyser && analyser.disconnect(); }catch{} analyser=null;
  try{ gainNode && gainNode.disconnect(); }catch{} gainNode=null;
  try{ splitter && splitter.disconnect(); }catch{} splitter=null;
  try{ merger && merger.disconnect(); }catch{} merger=null;
  try{ sourceNode && sourceNode.disconnect(); }catch{} sourceNode=null;

  if(audioCtx){ try{ audioCtx.close(); }catch{} audioCtx=null; }

  if(displayStream){ try{ displayStream.getTracks().forEach(t=>t.stop()); }catch{} displayStream=null; }
  if(srcStream){ try{ srcStream.getTracks().forEach(t=>t.stop()); }catch{} srcStream=null; }

  document.getElementById('tabBtn').disabled = false;
  document.getElementById('stopStudent').disabled = true;

  if(!keepTeacher) statusEl.textContent='idle';
  updateDiag({msg:'student stopped'});
}

/*** ------------ AI hints ------------ ***/
let busy=false;
async function requestHints(){
  if(busy) return; busy=true;
  try{
    const r = await fetch('/api/hints', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ teacher: tFull, student: sFull })
    });
    const d = await r.json();
    if(d?.card) prependCard(d.card);
  }catch(e){ console.warn(e); }
  busy=false;
}
function prependCard(card){
  const hasContent=(card.errors&&card.errors.length)||(card.definitions&&card.definitions.length)||(card.synonyms&&card.synonyms.length);
  if(!hasContent) return;
  const div=document.createElement('div'); div.className='entry';
  div.innerHTML=`<div class="cols">
    <div class="col error"><h4>Errors & Fix</h4><div class="errors"></div></div>
    <div class="col def"><h4>Definitions</h4><div class="defs"></div></div>
    <div class="col syn"><h4>Synonyms</h4><div class="syns"></div></div>
  </div>`;
  const eW=div.querySelector('.errors'), dW=div.querySelector('.defs'), sW=div.querySelector('.syns');
  (card.errors||[]).forEach(e=>{ const el=document.createElement('div'); el.className='errItem'; el.innerHTML=`<b>${e.title||'Mistake'}</b><br>‚ùå ${e.wrong||''}<br>‚úÖ ${e.fix||''}<div>${e.explanation||''}</div>`; eW.appendChild(el); });
  (card.definitions||[]).forEach(x=>{ const el=document.createElement('div'); el.className='defItem'; el.innerHTML=`<b>${x.word||''}</b> (${x.pos||''}) ‚Äî ${x.simple_def||''}`; dW.appendChild(el); });
  (card.synonyms||[]).forEach(x=>{ const el=document.createElement('div'); el.className='synItem'; el.innerHTML=`<b>${x.word||''}</b> (${x.pos||''}) ‚Üí ${(x.list||[]).join(', ')}`; sW.appendChild(el); });
  feed.prepend(div); while(feed.children.length>30) feed.removeChild(feed.lastChild);
}

/*** ------------ Quick test ------------ ***/
document.getElementById('sendManual').onclick = () => {
  const el=document.getElementById('manualText'); const t=el.value.trim(); if(!t) return;
  tFull=tFull?(tFull+' '+t):t; teacherOut.textContent=tFull;
  const tt=tail(tFull); if(tt && tt!==tLast){ tLast=tt; requestHints(); }
  el.value=''; clearTimeout(tPauseTimer); tPauseTimer=setTimeout(()=>{ tFull=""; tLast=""; teacherOut.textContent="‚Äî"; }, PAUSE_MS);
};

/*** ------------ Bind ------------ ***/
document.getElementById('micBtn').onclick = startTeacher;
document.getElementById('stopTeacher').onclick = stopTeacher;
document.getElementById('tabBtn').onclick = startStudent;
document.getElementById('stopStudent').onclick = stopStudent;
document.getElementById('forceFlush').onclick = () => flushWav(true);

updateDiag();
</script>
</body>
</html>
