<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Teaching POPO ‚Äî AI Hints (Private)</title>
  <style>
    :root{
      --card:#fff;
      --border:#e6e7ef;
      --muted:#666;
      --error-bg:#ffe9d6;
      --error-border:#ffb980;

      --def-bg:#efe7ff;   /* —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ */
      --def-border:#c9b6ff;

      --syn-bg:#e8f7e8;   /* –∑–µ–ª—ë–Ω—ã–µ */
      --syn-border:#b8e6b8;

      --col-gap:12px;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; background:#fafbff;}
    .wrap { max-width: 1200px; margin: 0 auto; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .card { border:1px solid var(--border); border-radius:14px; padding:14px; background:var(--card); margin-bottom:12px; }
    .live { background:#f6f7fb; padding:12px; border-radius:12px; min-height:70px; border:1px solid var(--border); }
    button { padding:10px 14px; border-radius:10px; border:1px solid #d0d3db; background:#fff; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .note { color:var(--muted); font-size: 0.95rem; }
    .ok { color: #1b5e20; }
    .warn { color: #b71c1c; }

    .topgrid { display:grid; grid-template-columns: 1fr 320px; gap:12px; align-items:start; }
    @media (max-width: 1000px) { .topgrid { grid-template-columns: 1fr; } }

    /* transcripts: teacher | student */
    .twocol { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 1000px) { .twocol { grid-template-columns: 1fr; } }

    /* FEED: –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–≤–µ—Ä—Ö—É */
    .feed { display:flex; flex-direction: column; gap: 12px; }
    .entry { border:1px solid var(--border); border-radius:14px; padding:12px; background:#fff; }
    .cols { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--col-gap); }
    .col { border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
    .col h4 { margin:0 0 8px 0; }

    .error { background:var(--error-bg); border-color: var(--error-border); }
    .def   { background:var(--def-bg);   border-color: var(--def-border); }
    .syn   { background:var(--syn-bg);   border-color: var(--syn-border); }

    .errItem { background:var(--error-bg); border:1px solid var(--error-border); border-radius:10px; padding:10px; margin:8px 0; }
    .errTitle { font-weight:700; color:#b45309; }
    .wrong { margin-top:6px; }
    .fix { font-weight:700; margin-top:4px; }
    .ex { color:#444; margin-top:4px; }

    .defItem { background:#f6f0ff; border:1px solid var(--def-border); border-radius:10px; padding:10px; margin:8px 0; }
    .synItem { background:#f0fff0; border:1px solid var(--syn-border); border-radius:10px; padding:10px; margin:8px 0; }
    .word { font-weight:700; }

    @media (max-width: 900px) { .cols { grid-template-columns: 1fr; } }

    .quick input { width: 100%; padding: 10px; border:1px solid #ddd; border-radius:10px;}
    .quick button { padding: 10px 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Teaching POPO ‚Äî AI Hints</h1>
    <p class="note">Choose audio source(s) ‚Üí start ‚Üí AI shows structured hints below. Teacher & Student transcripts are separate.</p>

    <div class="topgrid">
      <!-- –ª–µ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: –∏—Å—Ç–æ—á–Ω–∏–∫–∏ -->
      <div class="card">
        <div class="row">
          <label>Teacher input:</label>
          <button id="micBtn">üéôÔ∏è Teacher Mic</button>
          <button id="stopTeacher" disabled>‚èπÔ∏è Stop</button>
        </div>
        <div class="row" style="margin-top:8px">
          <label>Student input:</label>
          <button id="tabBtn">üñ•Ô∏è Student Tab (with audio)</button>
          <button id="stopStudent" disabled>‚èπÔ∏è Stop</button>
        </div>
        <p class="note" style="margin-top:6px">
          <b>Student Tab:</b> –≤—ã–±–µ—Ä–∏ –≤–∫–ª–∞–¥–∫—É –∏ –æ—Ç–º–µ—Ç—å ‚ÄúShare tab audio‚Äù. –ó–≤—É–∫ –≤–∫–ª–∞–¥–∫–∏ —É—Ö–æ–¥–∏—Ç –∫—É—Å–æ—á–∫–∞–º–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (Whisper) ‚Äî
          —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –æ—Ç —É—á–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.
        </p>
      </div>

      <!-- –ø—Ä–∞–≤–∞—è –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: Quick test -->
      <div class="card quick">
        <h3 style="margin-top:0">Quick test</h3>
        <div class="row" style="gap:8px">
          <input id="manualText" placeholder="Type a word or phrase‚Ä¶">
          <button id="sendManual">Send</button>
        </div>
        <p class="note" style="margin:8px 0 0">–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —É—á–∏—Ç–µ–ª—è.</p>
      </div>
    </div>

    <div class="twocol">
      <div>
        <h3>Teacher transcript</h3>
        <div id="teacherOut" class="live">‚Äî</div>
      </div>
      <div>
        <h3>Student transcript</h3>
        <div id="studentOut" class="live">‚Äî</div>
      </div>
    </div>

    <h3 style="margin-top:16px">AI hints for teacher (newest on top)</h3>
    <div id="feed" class="feed"></div>

    <p class="note">Status: <span id="status">idle</span></p>
  </div>

  <script>
    // DOM
    const statusEl = document.getElementById('status');
    const teacherOut = document.getElementById('teacherOut');
    const studentOut = document.getElementById('studentOut');
    const feed = document.getElementById('feed');

    const micBtn = document.getElementById('micBtn');
    const stopTeacherBtn = document.getElementById('stopTeacher');
    const tabBtn = document.getElementById('tabBtn');
    const stopStudentBtn = document.getElementById('stopStudent');

    // State
    let SR = null;           // SpeechRecognition instance (teacher)
    let keepTeacher = false;
    let tFull = "", sFull = "";
    let tLastTail = "", sLastTail = "";
    let pingTimer = null;

    // student capture
    let tabStream = null;
    let mediaRec = null;
    const CHUNK_MS = 1500; // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—É—Å–æ—á–∫–∏ —Ä–∞–∑ –≤ 1.5s

    // helpers
    function supportsSR() {
      return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
    }
    function tail(text, maxWords=15){
      const words = (text||"").trim().split(/\s+/);
      return words.slice(-maxWords).join(" ").toLowerCase();
    }
    function startPing(){
      if (!pingTimer) pingTimer = setInterval(()=>{ fetch('/api/health').catch(()=>{}); }, 20000);
    }
    function stopPing(){ if (pingTimer){ clearInterval(pingTimer); pingTimer=null; } }

    // ---------- Teacher (browser SR) ----------
    function initSR(lang='en-US'){
      const S = window.SpeechRecognition || window.webkitSpeechRecognition;
      SR = new S();
      SR.lang = lang;
      SR.interimResults = true;
      SR.continuous = true;

      SR.onresult = async (e) => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const r = e.results[i];
          if (r.isFinal) {
            const piece = r[0].transcript.trim();
            if (!piece) continue;
            tFull += (tFull ? ' ' : '') + piece;
            teacherOut.textContent = tFull;

            const t = tail(tFull);
            if (t && t !== tLastTail) {
              tLastTail = t;
              requestHints(); // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—â–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Å –æ–±–æ–∏—Ö –∫–∞–Ω–∞–ª–æ–≤
            }
          } else {
            interim += r[0].transcript;
          }
        }
        if (interim) teacherOut.textContent = (tFull + ' ' + interim).trim();
      };

      SR.onerror = (e) => {
        console.warn('Teacher SR error', e);
      };

      SR.onend = () => {
        if (keepTeacher) { try { SR.start(); } catch{} }
      };
    }

    async function startTeacher(){
      if (!supportsSR()) { alert('Update Chrome for SpeechRecognition API.'); return; }
      if (!SR) initSR('en-US');
      tFull = ""; tLastTail = "";
      teacherOut.textContent = "Listening (Teacher Mic)‚Ä¶";
      keepTeacher = true;
      statusEl.textContent = "listening (teacher)";
      try { await navigator.mediaDevices.getUserMedia({ audio: true }); } catch {}
      startPing();
      try { SR.start(); } catch {}
      micBtn.disabled = true; stopTeacherBtn.disabled = false;
    }
    function stopTeacher(){
      keepTeacher = false;
      try { SR && SR.stop(); } catch{}
      micBtn.disabled = false; stopTeacherBtn.disabled = true;
      if (!mediaRec) stopPing();
      statusEl.textContent = mediaRec ? "listening (student)" : "idle";
    }

    // ---------- Student (tab capture + Whisper) ----------
    async function startStudent(){
      try {
        tabStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
      } catch (e) {
        alert('Tab capture cancelled.');
        return;
      }
      sFull = ""; sLastTail = "";
      studentOut.textContent = "Capturing Student Tab‚Ä¶";
      startPing();

      // MediaRecorder ‚Üí –∫–∞–∂–¥—ã–µ CHUNK_MS –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—É—Å–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      mediaRec = new MediaRecorder(tabStream, { mimeType: 'audio/webm' });
      mediaRec.ondataavailable = async (ev) => {
        if (!ev.data || ev.data.size < 1000) return;
        const buf = await ev.data.arrayBuffer();
        const b64 = arrayBufferToBase64(buf);
        try {
          const resp = await fetch('/api/stt_student', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ audioBase64: b64, mime: 'audio/webm' })
          });
          const data = await resp.json();
          const text = (data?.text || '').trim();
          if (text) {
            sFull += (sFull ? ' ' : '') + text;
            studentOut.textContent = sFull;
            const t = tail(sFull);
            if (t && t !== sLastTail) {
              sLastTail = t;
              requestHints();
            }
          }
        } catch (e) {
          console.warn('Student STT error', e);
        }
      };
      mediaRec.start(CHUNK_MS);
      tabBtn.disabled = true; stopStudentBtn.disabled = false;
      statusEl.textContent = keepTeacher ? "listening (teacher + student)" : "listening (student)";
    }

    function stopStudent(){
      if (mediaRec) { try { mediaRec.stop(); } catch{} mediaRec = null; }
      if (tabStream) { tabStream.getTracks().forEach(t=>t.stop()); tabStream=null; }
      tabBtn.disabled = false; stopStudentBtn.disabled = true;
      if (!keepTeacher) stopPing();
      statusEl.textContent = keepTeacher ? "listening (teacher)" : "idle";
    }

    // ---------- Shared Hints ----------
    let hintsBusy = false;
    async function requestHints(){
      if (hintsBusy) return; // –ø—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–ø–ª—ã–≤–∞
      hintsBusy = true;
      try{
        const resp = await fetch('/api/hints', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ teacher: tFull, student: sFull })
        });
        const data = await resp.json();
        if (data && data.card) prependCard(data.card);
      } catch(e){ console.warn('Hints error', e); }
      hintsBusy = false;
    }

    function prependCard(card){
      const entry = document.createElement('div');
      entry.className = 'entry';
      entry.innerHTML = `
        <div class="cols">
          <div class="col error">
            <h4>Errors & Fix</h4>
            <div class="list errors"></div>
          </div>
          <div class="col def">
            <h4>Definitions</h4>
            <div class="list defs"></div>
          </div>
          <div class="col syn">
            <h4>Synonyms</h4>
            <div class="list syns"></div>
          </div>
        </div>
      `;

      const errsWrap = entry.querySelector('.errors');
      (card.errors || []).forEach(e => {
        const div = document.createElement('div');
        div.className = 'errItem';
        div.innerHTML = `
          <div class="errTitle">${e.title || 'Mistake'}</div>
          ${e.wrong ? `<div class="wrong">‚ùå ${e.wrong}</div>` : ''}
          ${e.fix ? `<div class="fix">‚úÖ ${e.fix}</div>` : ''}
          ${e.explanation ? `<div class="ex">${e.explanation}</div>` : ''}
        `;
        errsWrap.appendChild(div);
      });

      const defsWrap = entry.querySelector('.defs');
      (card.definitions || []).forEach(d => {
        const div = document.createElement('div');
        div.className = 'defItem';
        div.innerHTML = `<div class="word">${d.word || ''} (${d.pos || ''})</div>
                         <div>${d.simple_def || ''}</div>`;
        defsWrap.appendChild(div);
      });

      const synsWrap = entry.querySelector('.syns');
      (card.synonyms || []).forEach(s => {
        const div = document.createElement('div');
        div.className = 'synItem';
        const list = (s.list || []).join(', ');
        div.innerHTML = `<div class="word">${s.word || ''} (${s.pos || ''})</div>
                         <div>${list}</div>`;
        synsWrap.appendChild(div);
      });

      feed.prepend(entry);
      const max = 30;
      while (feed.children.length > max) feed.removeChild(feed.lastChild);
    }

    // quick test ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ —É—á–∏—Ç–µ–ª—è
    document.getElementById('sendManual').onclick = async () => {
      const el = document.getElementById('manualText');
      const t = el.value.trim();
      if (!t) return;
      tFull = tFull ? (tFull + ' ' + t) : t;
      teacherOut.textContent = tFull;
      const tt = tail(tFull);
      if (tt && tt !== tLastTail) {
        tLastTail = tt;
        requestHints();
      }
      el.value = '';
    };

    // bind
    micBtn.onclick = startTeacher;
    stopTeacherBtn.onclick = stopTeacher;
    tabBtn.onclick = startStudent;
    stopStudentBtn.onclick = stopStudent;

    // utils
    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary);
    }
  </script>
</body>
</html>
