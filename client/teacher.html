<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teacher ‚Äî AI Hints</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px;background:#fafbff}
    .wrap{max-width:1200px;margin:0 auto}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .card{background:#fff;padding:14px;border:1px solid #ddd;border-radius:12px;margin-bottom:12px}
    .live{background:#f5f6fb;border:1px solid #ddd;border-radius:10px;min-height:70px;padding:10px}
    .topgrid{display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start}
    @media(max-width:900px){.topgrid{grid-template-columns:1fr}}
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.twocol{grid-template-columns:1fr}}
    .feed{display:flex;flex-direction:column;gap:12px}
    .entry{background:#fff;border:1px solid #ddd;border-radius:12px;padding:10px}
    .cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media(max-width:900px){.cols{grid-template-columns:1fr}}
    .col{border:1px solid #ddd;border-radius:10px;padding:8px}
    .error{background:#ffe9d6;border-color:#ffb980}
    .def{background:#efe7ff;border-color:#c9b6ff}
    .syn{background:#e8f7e8;border-color:#b8e6b8}
    .errItem,.defItem,.synItem{margin:6px 0;padding:6px;border-radius:8px}
    .errItem{background:#fff0e5;border:1px solid #ffc58a}
    .defItem{background:#f5f0ff;border:1px solid #c9b6ff}
    .synItem{background:#f0fff0;border:1px solid #b8e6b8}
    .note{color:#666;font-size:.9rem}
    .diag{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1020;color:#d9e1ff;border-radius:12px;border:1px solid #263056;padding:12px;line-height:1.35;overflow:auto;position:relative}
    .ok{color:#9cff9c}.bad{color:#ff9c9c}.warn{color:#ffd27a}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #445}
    .ghost{position:absolute;right:8px;top:8px;opacity:.3}
    .diag:hover .ghost{opacity:1}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Teacher Panel ‚Äî Private AI Hints</h1>

  <div class="topgrid">
    <div class="card">
      <div class="row">
        <label><b>Teacher:</b></label>
        <button id="micBtn">üéôÔ∏è Teacher Mic</button>
        <button id="stopTeacher" disabled>‚èπÔ∏è Stop</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label><b>Student:</b></label>
        <button id="tabBtn">üñ•Ô∏è Student Tab (with audio)</button>
        <button id="stopStudent" disabled>‚èπÔ∏è Stop</button>
      </div>
      <p class="note" style="margin-top:6px">
        –í –¥–∏–∞–ª–æ–≥–µ Chrome –≤—ã–±–µ—Ä–∏ <b>Chrome Tab</b> –∏ –≤–∫–ª—é—á–∏ <b>Share tab audio</b>.
      </p>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Quick test</h3>
      <div class="row" style="gap:8px">
        <input id="manualText" placeholder="Type a word or phrase‚Ä¶" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:10px">
        <button id="sendManual">Send</button>
      </div>
      <p class="note" style="margin-top:8px">–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —É—á–∏—Ç–µ–ª—è.</p>
    </div>
  </div>

  <div class="twocol">
    <div>
      <h3>Teacher transcript</h3>
      <div id="teacherOut" class="live">‚Äî</div>
    </div>
    <div>
      <h3>Student transcript</h3>
      <div id="studentOut" class="live">‚Äî</div>
    </div>
  </div>

  <h3 style="margin-top:16px">AI hints (newest on top)</h3>
  <div id="feed" class="feed"></div>

  <h3 style="margin-top:16px">Diagnostics</h3>
  <div id="diag" class="diag">
    idle
    <button id="forceFlush" class="ghost">Force flush</button>
  </div>

  <p class="note" style="margin-top:8px">Status: <span id="status">idle</span></p>
</div>

<script>
/*** ------- –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ------- ***/
let SR, keepTeacher=false, tFull="", sFull="", tLast="", sLast="";
let displayStream=null, srcStream=null, boostedStream=null, mediaRec=null;

const MIME_CHAIN=['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4',''];
let mimeIdx=0;

const CHUNK_MS=1000;
const AGG_MS=3000;        // ‚¨ÖÔ∏è –±—É—Ñ–µ—Ä 3—Å (—Ä–∞–Ω—å—à–µ 4.5)
const HARD_FLUSH_MS=7000; // –º–∞–∫—Å–∏–º—É–º 7—Å ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º –¥–∞–∂–µ –≤ —Ç–∏—à–∏–Ω–µ
const PAUSE_MS=4000;

let tPauseTimer=null, sPauseTimer=null;
let studentPulse=null, studentWatchdog=null, flushTicker=null;
let lastChunkTs=0, chunkCount=0, lastSize=0;
let studentStopRequested=false;

let aggBlobs=[], aggMs=0, aggStart=0, sttBusy=false;

let audioCtx=null, analyser=null, gainNode=null, rms=0;
const VAD_TH=0.003; // –º—è–≥–∫–∏–π –ø–æ—Ä–æ–≥

let flushCount=0, lastFlushAt='‚Äî';

const statusEl=document.getElementById('status');
const teacherOut=document.getElementById('teacherOut');
const studentOut=document.getElementById('studentOut');
const feed=document.getElementById('feed');
const diagEl=document.getElementById('diag');

/*** ------- —É—Ç–∏–ª–∏—Ç—ã ------- ***/
function tail(t,n=15){return (t||"").trim().split(/\s+/).slice(-n).join(" ").toLowerCase();}
function supportsSR(){return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;}
function clearAfterPause(which){
  if(which==='t'){ clearTimeout(tPauseTimer); tPauseTimer=setTimeout(()=>{ tFull=""; tLast=""; teacherOut.textContent="‚Äî"; }, PAUSE_MS); }
  else{ clearTimeout(sPauseTimer); sPauseTimer=setTimeout(()=>{ sFull=""; sLast=""; studentOut.textContent="‚Äî"; }, PAUSE_MS); }
}
function arrayBufferToBase64(buffer){ let binary=''; const bytes=new Uint8Array(buffer); for(let i=0;i<bytes.length;i++) binary+=String.fromCharCode(bytes[i]); return btoa(binary); }
function now(){return new Date().toLocaleTimeString();}
function updateDiag(extra={}){
  const aTrack = boostedStream?.getAudioTracks?.()[0] || srcStream?.getAudioTracks?.()[0];
  const vTrack = displayStream?.getVideoTracks?.()[0];
  const age = lastChunkTs? ((Date.now()-lastChunkTs)/1000).toFixed(1)+'s' : '‚Äî';
  const level = rms ? rms.toFixed(3) : '0.000';
  const mime = mediaRec?.mimeType || MIME_CHAIN[mimeIdx] || 'auto';
  const recState = mediaRec?.state || '‚Äî';
  const aState = aTrack?.readyState || '‚Äî';
  const vState = vTrack?.readyState || '‚Äî';
  diagEl.firstChild && (diagEl.firstChild.textContent = '');
  diagEl.innerHTML = `
time: ${now()}<br>
recorder: <span class="${recState==='recording'?'ok':'warn'}">${recState}</span>
  ‚Ä¢ mime: <span class="chip">${mime}</span>
  ‚Ä¢ chunks: ${chunkCount}
  ‚Ä¢ lastSize: ${lastSize} bytes
  ‚Ä¢ lastChunkAge: ${age}
  ‚Ä¢ aggMs: ${aggMs}ms
  ‚Ä¢ sttBusy: ${sttBusy}
  ‚Ä¢ flushes: ${flushCount}
  ‚Ä¢ lastFlushAt: ${lastFlushAt}<br>
audio track: <span class="${aState==='live'?'ok':'bad'}">${aState}</span>
  ‚Ä¢ level(RMS): ${level}
  ‚Ä¢ boost: x${(gainNode?.gain?.value||1).toFixed(1)}<br>
video track: ${vState}<br>
${extra.msg?('<span class="warn">'+extra.msg+'</span>'):''}
<button id="forceFlush" class="ghost">Force flush</button>
`.trim();
  const ff=document.getElementById('forceFlush'); if(ff) ff.onclick=()=>flushAgg(true,true);
}

/*** ------- Teacher (SR) ------- ***/
function initSR(){
  const S=window.SpeechRecognition||window.webkitSpeechRecognition;
  SR=new S(); SR.lang='en-US'; SR.interimResults=true; SR.continuous=true;
  SR.onresult=async e=>{
    let interim=''; for(let i=e.resultIndex;i<e.results.length;i++){ const r=e.results[i];
      if(r.isFinal){ const piece=r[0].transcript.trim(); if(!piece) continue;
        tFull+=(tFull?' ':'')+piece; teacherOut.textContent=tFull;
        const tt=tail(tFull); if(tt && tt!==tLast){ tLast=tt; requestHints(); }
        clearAfterPause('t');
      } else { interim+=r[0].transcript; }
    }
    if(interim) teacherOut.textContent=(tFull+' '+interim).trim();
  };
  SR.onerror=()=>{}; SR.onend=()=>{ if(keepTeacher){ try{ SR.start(); }catch{} } };
}
async function startTeacher(){
  if(!supportsSR()){ alert('Update Chrome for SpeechRecognition API.'); return; }
  if(!SR) initSR(); try{ await navigator.mediaDevices.getUserMedia({audio:true}); }catch{}
  tFull=""; tLast=""; teacherOut.textContent="Listening (Teacher Mic)‚Ä¶";
  keepTeacher=true; SR.start(); document.getElementById('micBtn').disabled=true; document.getElementById('stopTeacher').disabled=false;
  statusEl.textContent='listening (teacher)'; clearAfterPause('t');
}
function stopTeacher(){
  keepTeacher=false; try{ SR && SR.stop(); }catch{} document.getElementById('micBtn').disabled=false; document.getElementById('stopTeacher').disabled=true;
  if(!mediaRec) statusEl.textContent='idle';
}

/*** ------- Student (tab ‚Üí boost ‚Üí recorder ‚Üí Whisper) ------- ***/
async function startStudent(){
  try{ displayStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true }); }
  catch{ alert('–í—ã–±–æ—Ä –≤–∫–ª–∞–¥–∫–∏ –æ—Ç–º–µ–Ω—ë–Ω.'); return; }

  const aTracks = displayStream.getAudioTracks();
  if(!aTracks || aTracks.length===0){ alert('–ù–µ—Ç –∞—É–¥–∏–æ! –í–∫–ª—é—á–∏ "Share tab audio".'); displayStream.getTracks().forEach(t=>t.stop()); displayStream=null; return; }
  const srcTrack = aTracks[0]; srcStream = new MediaStream([srcTrack]);

  try{
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(srcStream);
    gainNode = audioCtx.createGain(); gainNode.gain.value = 2.5;
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 512;
    const dest = audioCtx.createMediaStreamDestination();
    source.connect(gainNode); gainNode.connect(analyser); gainNode.connect(dest);
    boostedStream = dest.stream;
    const data = new Uint8Array(analyser.fftSize);
    (function meter(){ if(!analyser) return; analyser.getByteTimeDomainData(data);
      let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
      rms = Math.sqrt(sum/data.length); updateDiag(); requestAnimationFrame(meter);
    })();
  }catch(e){ boostedStream = srcStream; updateDiag({msg:'boost disabled: '+e.message}); }

  displayStream.getVideoTracks().forEach(tr => tr.addEventListener('ended', () => { updateDiag({msg:'display video ended'}); stopStudent(); }));

  sFull=""; sLast=""; studentOut.textContent="Capturing Student Tab‚Ä¶";
  studentStopRequested=false; chunkCount=0; lastSize=0; lastChunkTs=0; mimeIdx=0;
  aggBlobs=[]; aggMs=0; sttBusy=false; aggStart=Date.now(); flushCount=0; lastFlushAt='‚Äî';

  startRecorderWithCurrentMime();

  clearInterval(studentPulse);
  studentPulse = setInterval(() => { try{ mediaRec && mediaRec.state==='recording' && mediaRec.requestData(); }catch{} }, CHUNK_MS);

  clearInterval(studentWatchdog);
  studentWatchdog = setInterval(() => {
    const gap = Date.now() - (lastChunkTs||0);
    if (mediaRec && mediaRec.state==='recording' && gap > 6000) {
      updateDiag({msg:`watchdog: restart (gap=${gap}ms)`});
      try { mediaRec.stop(); } catch {}
    }
  }, 2000);

  clearInterval(flushTicker);
  flushTicker = setInterval(checkFlush, 1000);

  document.getElementById('tabBtn').disabled=true; document.getElementById('stopStudent').disabled=false;
  statusEl.textContent = keepTeacher ? 'listening (teacher + student)' : 'listening (student)';
  clearAfterPause('s');
}

function startRecorderWithCurrentMime(force=false){
  if (!boostedStream) return;
  if (mediaRec && !force) { try{ mediaRec.start(CHUNK_MS); }catch{} return; }
  try{
    const conf = MIME_CHAIN[mimeIdx] ? { mimeType: MIME_CHAIN[mimeIdx], audioBitsPerSecond: 128000 } : { audioBitsPerSecond: 128000 };
    mediaRec = new MediaRecorder(boostedStream, conf);
  }catch(e){ updateDiag({msg:`init fail for ${MIME_CHAIN[mimeIdx]}: ${e.message}`}); mimeIdx=(mimeIdx+1)%MIME_CHAIN.length; return startRecorderWithCurrentMime(true); }

  mediaRec.ondataavailable = (ev) => {
    if(!ev.data || ev.data.size < 800){ updateDiag({msg:'tiny chunk skipped'}); return; }
    lastChunkTs = Date.now(); chunkCount++; lastSize = ev.data.size;
    aggBlobs.push(ev.data); aggMs += CHUNK_MS; updateDiag();
  };
  mediaRec.onstop = ()=>{ updateDiag({msg:'recorder stopped'}); if(!studentStopRequested && boostedStream?.getAudioTracks?.()[0]?.readyState==='live'){ setTimeout(()=>startRecorderWithCurrentMime(true), 200); } };
  mediaRec.onerror = e=> updateDiag({msg:`recorder error: ${e.name||e.message}`});
  mediaRec.onstart = ()=> updateDiag({msg:'recorder started'});
  try{ mediaRec.start(CHUNK_MS); }catch(e){ updateDiag({msg:`start failed: ${e.message}`}); mimeIdx=(mimeIdx+1)%MIME_CHAIN.length; startRecorderWithCurrentMime(true); }
}

function checkFlush(){
  const hard = (Date.now()-aggStart) >= HARD_FLUSH_MS;
  if (!sttBusy && aggBlobs.length && (aggMs >= AGG_MS || hard)) {
    flushAgg(hard /*force*/, false /*manual*/);
  }
}

async function flushAgg(force=false, manual=false){
  if (!aggBlobs.length || sttBusy) return;

  if (!force && rms < VAD_TH && aggMs < HARD_FLUSH_MS) {
    updateDiag({msg:`VAD hold (rms=${rms.toFixed(3)})`});
    return;
  }

  let blob = new Blob(aggBlobs, { type: aggBlobs[0].type || 'audio/webm' });
  // –æ–≥—Ä–∞–Ω–∏—á–∏–º —Ä–∞–∑–º–µ—Ä —Ç–µ–ª–∞ –≤ ~4 –ú–ë (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
  const MAX = 4 * 1024 * 1024;
  if (blob.size > MAX) blob = blob.slice(blob.size - MAX);

  aggBlobs=[]; aggMs=0; aggStart=Date.now();
  sttBusy = true; flushCount++; lastFlushAt=now();
  updateDiag({msg:`flush ‚Üí ${manual?'manual':'auto'} (${blob.size} bytes)`});

  try{
    const buf = await blob.arrayBuffer();
    const b64 = arrayBufferToBase64(buf);

    const resp = await fetch('/api/stt_student', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ audioBase64: b64 })
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(()=> '');
      updateDiag({msg:`/api/stt_student ${resp.status} ${resp.statusText} ${txt.slice(0,200)}`});
      return;
    }

    const data = await resp.json().catch(()=> ({}));
    const text = (data?.text || '').trim();
    if(text){
      sFull += (sFull ? ' ' : '') + text;
      studentOut.textContent = sFull;
      const st = tail(sFull); if(st && st !== sLast){ sLast = st; requestHints(); }
      clearAfterPause('s');
    } else {
      updateDiag({msg:'STT ok, but empty text'});
    }
  } catch(err){
    updateDiag({msg:`upload/STT error: ${err.message}`});
  } finally {
    sttBusy = false;
    updateDiag();
  }
}

function stopStudent(){
  studentStopRequested = true;
  try{ mediaRec && mediaRec.state!=='inactive' && mediaRec.stop(); }catch{} mediaRec = null;

  clearInterval(studentPulse); studentPulse=null;
  clearInterval(studentWatchdog); studentWatchdog=null;
  clearInterval(flushTicker); flushTicker=null;

  if(boostedStream){ try{ boostedStream.getTracks().forEach(t=>t.stop()); }catch{} boostedStream=null; }
  if(srcStream){ try{ srcStream.getTracks().forEach(t=>t.stop()); }catch{} srcStream=null; }
  if(displayStream){ try{ displayStream.getTracks().forEach(t=>t.stop()); }catch{} displayStream=null; }

  if(analyser){ try{ analyser.disconnect(); }catch{} analyser=null; }
  if(gainNode){ try{ gainNode.disconnect(); }catch{} gainNode=null; }
  if(audioCtx){ try{ audioCtx.close(); }catch{} audioCtx=null; }

  rms = 0; aggBlobs=[]; aggMs=0; sttBusy=false; flushCount=0; lastFlushAt='‚Äî';

  document.getElementById('tabBtn').disabled=false; document.getElementById('stopStudent').disabled=true;
  statusEl.textContent = keepTeacher ? 'listening (teacher)' : 'idle';
  updateDiag({msg:'student stopped'});
}

/*** ------- AI hints ------- ***/
let busy=false;
async function requestHints(){
  if(busy) return; busy=true;
  try{
    const r = await fetch('/api/hints', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ teacher: tFull, student: sFull }) });
    const d = await r.json(); if(d?.card) prependCard(d.card);
  }catch(e){ console.warn(e); }
  busy=false;
}
function prependCard(card){
  const hasContent=(card.errors&&card.errors.length)||(card.definitions&&card.definitions.length)||(card.synonyms&&card.synonyms.length);
  if(!hasContent) return;
  const div=document.createElement('div'); div.className='entry';
  div.innerHTML=`<div class="cols">
    <div class="col error"><h4>Errors & Fix</h4><div class="errors"></div></div>
    <div class="col def"><h4>Definitions</h4><div class="defs"></div></div>
    <div class="col syn"><h4>Synonyms</h4><div class="syns"></div></div>
  </div>`;
  const eW=div.querySelector('.errors'), dW=div.querySelector('.defs'), sW=div.querySelector('.syns');
  (card.errors||[]).forEach(e=>{ const el=document.createElement('div'); el.className='errItem'; el.innerHTML=`<b>${e.title||'Mistake'}</b><br>‚ùå ${e.wrong||''}<br>‚úÖ ${e.fix||''}<div>${e.explanation||''}</div>`; eW.appendChild(el); });
  (card.definitions||[]).forEach(x=>{ const el=document.createElement('div'); el.className='defItem'; el.innerHTML=`<b>${x.word||''}</b> (${x.pos||''}) ‚Äî ${x.simple_def||''}`; dW.appendChild(el); });
  (card.synonyms||[]).forEach(x=>{ const el=document.createElement('div'); el.className='synItem'; el.innerHTML=`<b>${x.word||''}</b> (${x.pos||''}) ‚Üí ${(x.list||[]).join(', ')}`; sW.appendChild(el); });
  feed.prepend(div); while(feed.children.length>30) feed.removeChild(feed.lastChild);
}

/*** ------- Quick test ------- ***/
document.getElementById('sendManual').onclick=()=>{ const el=document.getElementById('manualText'); const t=el.value.trim(); if(!t) return;
  tFull=tFull?(tFull+' '+t):t; teacherOut.textContent=tFull; const tt=tail(tFull); if(tt&&tt!==tLast){ tLast=tt; requestHints(); } el.value=''; clearAfterPause('t'); };

/*** ------- Bind ------- ***/
document.getElementById('micBtn').onclick = startTeacher;
document.getElementById('stopTeacher').onclick = stopTeacher;
document.getElementById('tabBtn').onclick = startStudent;
document.getElementById('stopStudent').onclick = stopStudent;
document.getElementById('forceFlush').onclick = ()=>flushAgg(true,true);

updateDiag();
</script>
</body>
</html>
