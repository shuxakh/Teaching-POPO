<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teacher ‚Äî AI Hints</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;margin:24px;background:#fafbff}
    .wrap{max-width:1200px;margin:0 auto}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .card{background:#fff;padding:14px;border:1px solid #ddd;border-radius:12px;margin-bottom:12px}
    .live{background:#f5f6fb;border:1px solid #ddd;border-radius:10px;min-height:70px;padding:10px}
    .topgrid{display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start}
    @media(max-width:900px){.topgrid{grid-template-columns:1fr}}
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.twocol{grid-template-columns:1fr}}
    .feed{display:flex;flex-direction:column;gap:12px}
    .entry{background:#fff;border:1px solid #ddd;border-radius:12px;padding:10px}
    .cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media(max-width:900px){.cols{grid-template-columns:1fr}}
    .col{border:1px solid #ddd;border-radius:10px;padding:8px}
    .error{background:#ffe9d6;border-color:#ffb980}
    .def{background:#efe7ff;border-color:#c9b6ff}
    .syn{background:#e8f7e8;border-color:#b8e6b8}
    .errItem,.defItem,.synItem{margin:6px 0;padding:6px;border-radius:8px}
    .errItem{background:#fff0e5;border:1px solid #ffc58a}
    .defItem{background:#f5f0ff;border:1px solid #c9b6ff}
    .synItem{background:#f0fff0;border:1px solid #b8e6b8}
    .note{color:#666;font-size:.9rem}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Teacher Panel ‚Äî Private AI Hints</h1>

  <div class="topgrid">
    <!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ -->
    <div class="card">
      <div class="row">
        <label><b>Teacher:</b></label>
        <button id="micBtn">üéôÔ∏è Teacher Mic</button>
        <button id="stopTeacher" disabled>‚èπÔ∏è Stop</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label><b>Student:</b></label>
        <button id="tabBtn">üñ•Ô∏è Student Tab (with audio)</button>
        <button id="stopStudent" disabled>‚èπÔ∏è Stop</button>
      </div>
      <p class="note" style="margin-top:6px">
        –í –¥–∏–∞–ª–æ–≥–µ Chrome –≤—ã–±–µ—Ä–∏ <b>Chrome Tab</b> –∏ –≤–∫–ª—é—á–∏ <b>Share tab audio</b>.
      </p>
    </div>

    <!-- Quick test -->
    <div class="card">
      <h3 style="margin:0 0 8px">Quick test</h3>
      <div class="row" style="gap:8px">
        <input id="manualText" placeholder="Type a word or phrase‚Ä¶" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:10px">
        <button id="sendManual">Send</button>
      </div>
      <p class="note" style="margin-top:8px">–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —É—á–∏—Ç–µ–ª—è.</p>
    </div>
  </div>

  <div class="twocol">
    <div>
      <h3>Teacher transcript</h3>
      <div id="teacherOut" class="live">‚Äî</div>
    </div>
    <div>
      <h3>Student transcript</h3>
      <div id="studentOut" class="live">‚Äî</div>
    </div>
  </div>

  <h3 style="margin-top:16px">AI hints (newest on top)</h3>
  <div id="feed" class="feed"></div>

  <p class="note">Status: <span id="status">idle</span></p>
</div>

<script>
/* ====== state & helpers ====== */
let SR, keepTeacher=false, tFull="", sFull="", tLast="", sLast="";
let displayStream=null, audioStream=null, mediaRec=null;
const CHUNK_MS=1000;     // —á–∞—â–µ ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –ø–æ—Ç–æ–∫
const PAUSE_MS=4000;     // –∞–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –ø–∞—É–∑—ã
let tPauseTimer=null, sPauseTimer=null;
let studentPulse=null, studentWatchdog=null, lastChunkTs=0;
let studentStopRequested=false;

const statusEl=document.getElementById('status');
const teacherOut=document.getElementById('teacherOut');
const studentOut=document.getElementById('studentOut');
const feed=document.getElementById('feed');

function tail(t,n=15){return (t||"").trim().split(/\s+/).slice(-n).join(" ").toLowerCase();}
function supportsSR(){return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;}
function clearAfterPause(which){
  if(which==='t'){
    clearTimeout(tPauseTimer);
    tPauseTimer=setTimeout(()=>{ tFull=""; tLast=""; teacherOut.textContent="‚Äî"; }, PAUSE_MS);
  }else{
    clearTimeout(sPauseTimer);
    sPauseTimer=setTimeout(()=>{ sFull=""; sLast=""; studentOut.textContent="‚Äî"; }, PAUSE_MS);
  }
}
function pickMime(){
  const cand=['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
  for(const m of cand){ if(MediaRecorder.isTypeSupported?.(m)) return m; }
  return '';
}
function arrayBufferToBase64(buffer){
  let binary=''; const bytes=new Uint8Array(buffer);
  for(let i=0;i<bytes.length;i++) binary+=String.fromCharCode(bytes[i]);
  return btoa(binary);
}

/* ====== Teacher (SpeechRecognition) ====== */
function initSR(){
  const S=window.SpeechRecognition||window.webkitSpeechRecognition;
  SR=new S(); SR.lang='en-US'; SR.interimResults=true; SR.continuous=true;

  SR.onresult=async e=>{
    let interim='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const r=e.results[i];
      if(r.isFinal){
        const piece=r[0].transcript.trim(); if(!piece) continue;
        tFull+=(tFull?' ':'')+piece; teacherOut.textContent=tFull;
        const tt=tail(tFull); if(tt && tt!==tLast){ tLast=tt; requestHints(); }
        clearAfterPause('t');
      } else {
        interim+=r[0].transcript;
      }
    }
    if(interim) teacherOut.textContent=(tFull+' '+interim).trim();
  };
  SR.onerror=()=>{};
  SR.onend=()=>{ if(keepTeacher){ try{ SR.start(); }catch{} } };
}

async function startTeacher(){
  if(!supportsSR()){ alert('Update Chrome for SpeechRecognition API.'); return; }
  if(!SR) initSR();
  try{ await navigator.mediaDevices.getUserMedia({audio:true}); }catch{}
  tFull=""; tLast=""; teacherOut.textContent="Listening (Teacher Mic)‚Ä¶";
  keepTeacher=true; SR.start();
  document.getElementById('micBtn').disabled=true;
  document.getElementById('stopTeacher').disabled=false;
  statusEl.textContent='listening (teacher)';
  clearAfterPause('t');
}
function stopTeacher(){
  keepTeacher=false; try{ SR && SR.stop(); }catch{}
  document.getElementById('micBtn').disabled=false;
  document.getElementById('stopTeacher').disabled=true;
  if(!mediaRec) statusEl.textContent='idle';
}

/* ====== Student (tab audio ‚Üí Whisper) ====== */
async function startStudent(){
  // 1) –∑–∞–ø—Ä–æ—Å —à–∞—Ä–∏–Ω–≥–∞ –≤–∫–ª–∞–¥–∫–∏
  try{
    displayStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
  }catch{
    alert('–í—ã–±–æ—Ä –≤–∫–ª–∞–¥–∫–∏ –æ—Ç–º–µ–Ω—ë–Ω.');
    return;
  }

  // 2) –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ-—Ç—Ä–µ–∫
  const aTracks = displayStream.getAudioTracks();
  if(!aTracks || aTracks.length===0){
    alert('–ù–µ—Ç –∞—É–¥–∏–æ! –í—ã–±–µ—Ä–∏ "Chrome Tab" –∏ –≤–∫–ª—é—á–∏ "Share tab audio".');
    displayStream.getTracks().forEach(t=>t.stop()); displayStream=null;
    return;
  }
  const audioTrack = aTracks[0];
  audioStream = new MediaStream([audioTrack]);

  // —Å–æ–±—ã—Ç–∏—è —Ç—Ä–µ–∫–∞
  audioTrack.addEventListener('ended', () => stopStudent());
  audioTrack.addEventListener('mute',  () => console.log('student: mute'));
  audioTrack.addEventListener('unmute',()=> console.log('student: unmute'));

  // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç —à–∞—Ä–∏–Ω–≥ –≤–∏–¥–µ–æ ‚Äî —Ç–æ–∂–µ —Å—Ç–æ–ø
  displayStream.getVideoTracks().forEach(tr => tr.addEventListener('ended', () => stopStudent()));

  sFull=""; sLast=""; studentOut.textContent="Capturing Student Tab‚Ä¶";
  studentStopRequested=false;

  // 3) –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–∫–æ—Ä–¥–µ—Ä (–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç–µ–ª—å)
  setupStudentRecorder(); // —Å–æ–∑–¥–∞—ë—Ç mediaRec –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç .start()

  // —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π ¬´–ø—É–ª—å—Å¬ª + watchdog
  lastChunkTs = Date.now();
  clearInterval(studentPulse);
  studentPulse = setInterval(() => {
    try{ mediaRec && mediaRec.state==='recording' && mediaRec.requestData(); }catch{}
  }, CHUNK_MS);

  clearInterval(studentWatchdog);
  studentWatchdog = setInterval(() => {
    if (!audioTrack || audioTrack.readyState !== 'live') return;
    const gap = Date.now() - lastChunkTs;
    if (gap > 6000) {               // 6—Å –±–µ–∑ –∫—É—Å–æ—á–∫–æ–≤ ‚Üí –º—è–≥–∫–∏–π —Ä–µ—Å—Ç–∞—Ä—Ç
      console.log('watchdog: restart mediaRec');
      try { mediaRec && mediaRec.stop(); } catch {}
      // onstop –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç
    }
  }, 2000);

  document.getElementById('tabBtn').disabled=true;
  document.getElementById('stopStudent').disabled=false;
  statusEl.textContent = keepTeacher ? 'listening (teacher + student)' : 'listening (student)';
  clearAfterPause('s');
}

/* —Å–æ–∑–¥–∞—ë—Ç/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç MediaRecorder –ø–æ–≤–µ—Ä—Ö audioStream */
function setupStudentRecorder(){
  if (!audioStream) return;
  const mime = pickMime();
  try{
    mediaRec = new MediaRecorder(audioStream, mime ? { mimeType: mime } : {});
  }catch(e){
    console.warn('Recorder init fail', e);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ –≤–∫–ª–∞–¥–∫–∏.');
    stopStudent();
    return;
  }

  mediaRec.ondataavailable = async (ev) => {
    if(!ev.data || ev.data.size < 800) return;
    lastChunkTs = Date.now();
    try{
      const buf = await ev.data.arrayBuffer();
      const b64 = arrayBufferToBase64(buf);
      const resp = await fetch('/api/stt_student', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ audioBase64: b64 })
      });
      const data = await resp.json();
      const text = (data?.text || '').trim();
      if(text){
        sFull += (sFull ? ' ' : '') + text;
        studentOut.textContent = sFull;
        const st = tail(sFull); if(st && st !== sLast){ sLast = st; requestHints(); }
        clearAfterPause('s');
      }
    }catch(err){ console.warn('STT error', err); }
  };

  mediaRec.onstop = () => {
    // –µ—Å–ª–∏ —Å—Ç–æ–ø –±—ã–ª –Ω–µ –ø–æ –Ω–∞—à–µ–π –∫–Ω–æ–ø–∫–µ ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–º
    if (!studentStopRequested && audioStream && audioStream.getAudioTracks()[0]?.readyState === 'live') {
      setTimeout(() => {
        console.log('mediaRec auto-restart');
        try { setupStudentRecorder(); } catch {}
      }, 200);
    }
  };

  mediaRec.onerror = (e) => console.warn('MediaRecorder error', e);

  try { mediaRec.start(CHUNK_MS); }
  catch(e){
    console.warn('mediaRec.start failed', e);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å. –í–∫–ª—é—á–∏ "Share tab audio" –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.');
    stopStudent();
  }
}

function stopStudent(){
  studentStopRequested = true;
  try{ mediaRec && mediaRec.state!=='inactive' && mediaRec.stop(); }catch{}
  mediaRec = null;

  clearInterval(studentPulse);      studentPulse=null;
  clearInterval(studentWatchdog);   studentWatchdog=null;

  if(audioStream){ try{ audioStream.getTracks().forEach(t=>t.stop()); }catch{} audioStream=null; }
  if(displayStream){ try{ displayStream.getTracks().forEach(t=>t.stop()); }catch{} displayStream=null; }

  document.getElementById('tabBtn').disabled=false;
  document.getElementById('stopStudent').disabled=true;
  statusEl.textContent = keepTeacher ? 'listening (teacher)' : 'idle';
}

/* ====== AI Hints (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø—É—Å—Ç—ã—Ö) ====== */
let busy=false;
async function requestHints(){
  if(busy) return; busy=true;
  try{
    const r = await fetch('/api/hints', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ teacher: tFull, student: sFull })
    });
    const d = await r.json();
    if(d?.card) prependCard(d.card);
  }catch(e){ console.warn(e); }
  busy=false;
}

function prependCard(card){
  const hasContent =
    (card.errors && card.errors.length) ||
    (card.definitions && card.definitions.length) ||
    (card.synonyms && card.synonyms.length);
  if (!hasContent) return;

  const div=document.createElement('div'); div.className='entry';
  div.innerHTML=`
    <div class="cols">
      <div class="col error"><h4>Errors & Fix</h4><div class="errors"></div></div>
      <div class="col def"><h4>Definitions</h4><div class="defs"></div></div>
      <div class="col syn"><h4>Synonyms</h4><div class="syns"></div></div>
    </div>`;
  const eW=div.querySelector('.errors'), dW=div.querySelector('.defs'), sW=div.querySelector('.syns');

  (card.errors||[]).forEach(e=>{
    const el=document.createElement('div'); el.className='errItem';
    el.innerHTML=`<b>${e.title||'Mistake'}</b><br>‚ùå ${e.wrong||''}<br>‚úÖ ${e.fix||''}<div>${e.explanation||''}</div>`;
    eW.appendChild(el);
  });
  (card.definitions||[]).forEach(x=>{
    const el=document.createElement('div'); el.className='defItem';
    el.innerHTML=`<b>${x.word||''}</b> (${x.pos||''}) ‚Äî ${x.simple_def||''}`;
    dW.appendChild(el);
  });
  (card.synonyms||[]).forEach(x=>{
    const el=document.createElement('div'); el.className='synItem';
    el.innerHTML=`<b>${x.word||''}</b> (${x.pos||''}) ‚Üí ${(x.list||[]).join(', ')}`;
    sW.appendChild(el);
  });

  feed.prepend(div);
  while(feed.children.length>30) feed.removeChild(feed.lastChild);
}

/* ====== Quick test ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ —É—á–∏—Ç–µ–ª—è ====== */
document.getElementById('sendManual').onclick = async () => {
  const el = document.getElementById('manualText');
  const t = el.value.trim(); if(!t) return;
  tFull = tFull ? (tFull + ' ' + t) : t;
  teacherOut.textContent = tFull;
  const tt = tail(tFull); if(tt && tt !== tLast){ tLast = tt; requestHints(); }
  el.value = '';
  clearAfterPause('t');
};

/* ====== Bind ====== */
document.getElementById('micBtn').onclick = startTeacher;
document.getElementById('stopTeacher').onclick = stopTeacher;
document.getElementById('tabBtn').onclick = startStudent;
document.getElementById('stopStudent').onclick = stopStudent;
</script>
</body>
</html>
