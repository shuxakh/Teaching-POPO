<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Teacher ‚Äî AI Hints (Private)</title>
  <style>
    :root{
      --card:#fff;
      --border:#e6e7ef;
      --muted:#666;
      --error-bg:#ffe9d6;
      --error-border:#ffb980;
      --col-gap:12px;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; background:#fafbff;}
    .wrap { max-width: 1100px; margin: 0 auto; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .card { border:1px solid var(--border); border-radius:14px; padding:14px; background:var(--card); margin-bottom:12px; }
    .live { background:#f6f7fb; padding:12px; border-radius:12px; min-height:70px; border:1px solid var(--border); }
    button { padding:10px 14px; border-radius:10px; border:1px solid #d0d3db; background:#fff; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .note { color:var(--muted); font-size: 0.95rem; }
    .ok { color: #1b5e20; }
    .warn { color: #b71c1c; }

    /* FEED: –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —Å–≤–µ—Ä—Ö—É —á–µ—Ä–µ–∑ prepend() */
    .feed { display:flex; flex-direction: column; gap: 12px; }
    .entry { border:1px solid var(--border); border-radius:14px; padding:12px; background:#fff; }
    .cols { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--col-gap); }
    .col { border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
    .col h4 { margin:0 0 8px 0; }
    .error { background:var(--error-bg); border-color: var(--error-border); }

    .errItem { background:var(--error-bg); border:1px solid var(--error-border); border-radius:10px; padding:10px; margin:8px 0; }
    .errTitle { font-weight:700; color:#b45309; }
    .wrong { margin-top:6px; }
    .fix { font-weight:700; margin-top:4px; }
    .ex { color:#444; margin-top:4px; }

    .defItem, .synItem { background:#f9fafb; border:1px solid var(--border); border-radius:10px; padding:10px; margin:8px 0; }
    .word { font-weight:700; }

    @media (max-width: 900px) {
      .cols { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Teacher Panel ‚Äî Private AI Hints</h1>
    <p class="note">Chrome only. Choose audio source ‚Üí start ‚Üí AI will show brief, structured hints only here.</p>

    <div class="card">
      <div class="row">
        <label>Audio source:</label>
        <button id="micBtn">üéôÔ∏è Microphone</button>
        <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
      </div>
      <p class="note">
        *–ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω (–ª—É—á—à–µ –Ω–∞—É—à–Ω–∏–∫–∏ —É—á–∏—Ç–µ–ª—é, —á—Ç–æ–±—ã –µ–≥–æ –≥–æ–ª–æ—Å –Ω–µ –ø–æ–ø–∞–¥–∞–ª –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω).
        –ü–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π Whisper –∏ —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã.
      </p>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –±–µ–∑ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ -->
    <div class="card">
      <h3>Quick test (no mic)</h3>
      <div class="row">
        <input id="manualText" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:10px" placeholder="Type a sentence here...">
        <button id="sendManual">Send</button>
      </div>
      <p class="note">–ù—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å AI, –¥–∞–∂–µ –µ—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω.</p>
    </div>

    <h3>Live transcript</h3>
    <div id="transcript" class="live">‚Äî</div>

    <h3>AI hints for teacher (newest on top)</h3>
    <div id="feed" class="feed"></div>

    <p class="note">Status: <span id="status">stopped</span></p>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const out = document.getElementById('transcript');
    const feed = document.getElementById('feed');
    const micBtn = document.getElementById('micBtn');
    const stopBtn = document.getElementById('stopBtn');

    let recog = null;
    let keepListening = false;
    let fullText = "";
    let lastSentTail = "";
    let pingTimer = null;

    function supportsSR() {
      return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
    }
    if (!supportsSR()) {
      alert("Your Chrome does not expose SpeechRecognition API. Please update Chrome.");
    }

    function tail(text, maxWords=25){
      const words = (text||"").trim().split(/\s+/);
      return words.slice(-maxWords).join(" ").toLowerCase();
    }

    function initRecog(lang='en-US') {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recog = new SR();
      recog.lang = lang;
      recog.interimResults = true;
      recog.continuous = true;

      recog.onresult = async (e) => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const r = e.results[i];
          if (r.isFinal) {
            const piece = r[0].transcript.trim();
            if (!piece) continue;

            fullText += (fullText ? ' ' : '') + piece;
            out.textContent = fullText;

            // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ö–≤–æ—Å—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è (–∞–Ω—Ç–∏-–¥—É–±–ª—å)
            const t = tail(fullText, 25);
            if (t && t !== lastSentTail) {
              lastSentTail = t;
              try {
                const resp = await fetch('/api/hints', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body:
