<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Teacher ‚Äî AI Hints (Private)</title>
  <style>
    :root{
      --card:#fff;
      --border:#e6e7ef;
      --muted:#666;
      --error-bg:#ffe9d6;
      --error-border:#ffb980;

      --def-bg:#efe7ff;   /* —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ */
      --def-border:#c9b6ff;

      --syn-bg:#e8f7e8;   /* –∑–µ–ª—ë–Ω—ã–µ */
      --syn-border:#b8e6b8;

      --col-gap:12px;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; background:#fafbff;}
    .wrap { max-width: 1100px; margin: 0 auto; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .card { border:1px solid var(--border); border-radius:14px; padding:14px; background:var(--card); margin-bottom:12px; }
    .live { background:#f6f7fb; padding:12px; border-radius:12px; min-height:70px; border:1px solid var(--border); }
    button { padding:10px 14px; border-radius:10px; border:1px solid #d0d3db; background:#fff; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .note { color:var(--muted); font-size: 0.95rem; }
    .ok { color: #1b5e20; }
    .warn { color: #b71c1c; }

    .topgrid { display:grid; grid-template-columns: 1fr 320px; gap:12px; align-items:start; }
    @media (max-width: 900px) { .topgrid { grid-template-columns: 1fr; } }

    /* FEED: –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–≤–µ—Ä—Ö—É */
    .feed { display:flex; flex-direction: column; gap: 12px; }
    .entry { border:1px solid var(--border); border-radius:14px; padding:12px; background:#fff; }
    .cols { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--col-gap); }
    .col { border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; }
    .col h4 { margin:0 0 8px 0; }

    .error { background:var(--error-bg); border-color: var(--error-border); }
    .def   { background:var(--def-bg);   border-color: var(--def-border); }
    .syn   { background:var(--syn-bg);   border-color: var(--syn-border); }

    .errItem { background:var(--error-bg); border:1px solid var(--error-border); border-radius:10px; padding:10px; margin:8px 0; }
    .errTitle { font-weight:700; color:#b45309; }
    .wrong { margin-top:6px; }
    .fix { font-weight:700; margin-top:4px; }
    .ex { color:#444; margin-top:4px; }

    .defItem { background:#f6f0ff; border:1px solid var(--def-border); border-radius:10px; padding:10px; margin:8px 0; }
    .synItem { background:#f0fff0; border:1px solid var(--syn-border); border-radius:10px; padding:10px; margin:8px 0; }
    .word { font-weight:700; }

    @media (max-width: 900px) { .cols { grid-template-columns: 1fr; } }

    /* –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –ø–æ–ª–µ Quick test */
    .quick input { width: 100%; padding: 10px; border:1px solid #ddd; border-radius:10px;}
    .quick button { padding: 10px 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Teacher Panel ‚Äî Private AI Hints</h1>
    <p class="note">Chrome only. Choose audio source ‚Üí start ‚Üí AI will show brief, structured hints only here.</p>

    <div class="topgrid">
      <!-- –ª–µ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
      <div class="card">
        <div class="row">
          <label>Audio source:</label>
          <button id="micBtn">üéôÔ∏è Microphone</button>
          <button id="tabBtn">üñ•Ô∏è Capture a Chrome Tab (with audio)</button>
          <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
        </div>
        <p class="note">
          <b>Capture Tab:</b> –≤—ã–±–µ—Ä–∏ –≤–∫–ª–∞–¥–∫—É –∏ –æ—Ç–º–µ—Ç—å ‚ÄúShare tab audio‚Äù. –ú—ã –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∑–≤—É–∫ –≤–∫–ª–∞–¥–∫–∏ —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏–∫–∏,
          –∞ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Web Speech API). –î–ª—è –∏–¥–µ–∞–ª–∞ –ø–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π Whisper.
        </p>
      </div>

      <!-- –ø—Ä–∞–≤–∞—è –º–∞–ª–µ–Ω—å–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: Quick test -->
      <div class="card quick">
        <h3 style="margin-top:0">Quick test</h3>
        <div class="row" style="gap:8px">
          <input id="manualText" placeholder="Type a word or phrase‚Ä¶">
          <button id="sendManual">Send</button>
        </div>
        <p class="note" style="margin:8px 0 0">–ù–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑—É, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ –ø—Ä–æ–∏–∑–Ω–µ—Å–ª–∏.</p>
      </div>
    </div>

    <h3>Live transcript</h3>
    <div id="transcript" class="live">‚Äî</div>

    <h3>AI hints for teacher (newest on top)</h3>
    <div id="feed" class="feed"></div>

    <p class="note">Status: <span id="status">stopped</span></p>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const out = document.getElementById('transcript');
    const feed = document.getElementById('feed');
    const micBtn = document.getElementById('micBtn');
    const tabBtn = document.getElementById('tabBtn');
    const stopBtn = document.getElementById('stopBtn');

    let recog = null;
    let keepListening = false;
    let fullText = "";
    let lastSentTail = "";
    let pingTimer = null;
    let tabAudioEl = null;
    let inactivityTimer = null;       // <-- –¢–ê–ô–ú-–ê–£–¢ –ü–ê–£–ó–´

    function supportsSR() {
      return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
    }
    function tail(text, maxWords=20){
      const words = (text||"").trim().split(/\s+/);
      return words.slice(-maxWords).join(" ").toLowerCase();
    }

    function startUI(mode){
      micBtn.disabled = true;
      tabBtn.disabled = true;
      stopBtn.disabled = false;
      statusEl.textContent = `listening (${mode})`;
      statusEl.className = "ok";
      if (!pingTimer) pingTimer = setInterval(() => { fetch('/api/health').catch(()=>{}); }, 20000);
    }
    function stopUI(){
      stopBtn.disabled = true;
      micBtn.disabled = false;
      tabBtn.disabled = false;
      statusEl.textContent = "stopped";
      statusEl.className = "";
      if (pingTimer) { clearInterval(pingTimer); pingTimer = null; }
      clearTimeout(inactivityTimer);
    }

    function scheduleClearAfterPause(ms=4000){
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        // –Ω–æ–≤–∞—è ¬´—Å—Ü–µ–Ω–∞¬ª: –æ—á–∏—â–∞–µ–º live –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        fullText = "";
        lastSentTail = "";
        out.textContent = "‚Äî";
      }, ms);
    }

    function initRecog(lang='en-US') {
      if (!supportsSR()) { alert("Update Chrome for SpeechRecognition API."); return; }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recog = new SR();
      recog.lang = lang;
      recog.interimResults = true;
      recog.continuous = true;

      recog.onresult = async (e) => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const r = e.results[i];
          if (r.isFinal) {
            const piece = r[0].transcript.trim();
            if (!piece) continue;

            fullText += (fullText ? ' ' : '') + piece;
            out.textContent = fullText;

            const t = tail(fullText, 20);
            if (t && t !== lastSentTail) {
              lastSentTail = t;
              try {
                const resp = await fetch('/api/hints', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ text: fullText })
                });
                const data = await resp.json();
                if (data && data.card) prependCard(data.card);
              } catch (e) { console.warn('Hints error', e); }
            }
            scheduleClearAfterPause(); // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç–µ
          } else {
            interim += r[0].transcript;
          }
        }
        if (interim) out.textContent = (fullText + ' ' + interim).trim();
      };

      recog.onerror = (e) => {
        console.warn('SpeechRecognition error', e);
        statusEl.textContent = "error (speech)";
        statusEl.className = "warn";
      };

      recog.onend = () => {
        if (keepListening) {
          try { recog.start(); } catch {}
        } else {
          stopUI();
        }
      };
    }

    async function startMic(){
      if (!recog) initRecog('en-US');
      fullText = ""; lastSentTail = "";
      out.textContent = "Listening via Microphone‚Ä¶";
      keepListening = true;
      startUI('mic');
      try { await navigator.mediaDevices.getUserMedia({ audio: true }); } catch {}
      scheduleClearAfterPause();
      try { recog.start(); } catch {}
    }

    async function startTabCapture(){
      if (!recog) initRecog('en-US');
      fullText = ""; lastSentTail = "";
      out.textContent = "Listening to captured tab‚Ä¶ (turn speakers on)";
      keepListening = true;
      startUI('tab');

      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        if (tabAudioEl) { try { tabAudioEl.pause(); } catch{} }
        tabAudioEl = new Audio();
        tabAudioEl.srcObject = stream;
        tabAudioEl.muted = false;
        tabAudioEl.play().catch(()=>{});
      } catch (e) {
        alert('Tab capture was cancelled. You can use Microphone instead.');
        stopAll();
        return;
      }
      scheduleClearAfterPause();
      try { recog.start(); } catch {}
    }

    function stopAll(){
      keepListening = false;
      try { recog && recog.stop(); } catch {}
      if (tabAudioEl) { try { tabAudioEl.pause(); } catch{} tabAudioEl = null; }
      stopUI();
    }

    function prependCard(card){
      const entry = document.createElement('div');
      entry.className = 'entry';
      entry.innerHTML = `
        <div class="cols">
          <div class="col error">
            <h4>Errors & Fix</h4>
            <div class="list errors"></div>
          </div>
          <div class="col def">
            <h4>Definitions</h4>
            <div class="list defs"></div>
          </div>
          <div class="col syn">
            <h4>Synonyms</h4>
            <div class="list syns"></div>
          </div>
        </div>
      `;

      const errsWrap = entry.querySelector('.errors');
      (card.errors || []).forEach(e => {
        const div = document.createElement('div');
        div.className = 'errItem';
        div.innerHTML = `
          <div class="errTitle">${e.title || 'Mistake'}</div>
          ${e.wrong ? `<div class="wrong">‚ùå ${e.wrong}</div>` : ''}
          ${e.fix ? `<div class="fix">‚úÖ ${e.fix}</div>` : ''}
          ${e.explanation ? `<div class="ex">${e.explanation}</div>` : ''}
        `;
        errsWrap.appendChild(div);
      });

      const defsWrap = entry.querySelector('.defs');
      (card.definitions || []).forEach(d => {
        const div = document.createElement('div');
        div.className = 'defItem';
        div.innerHTML = `<div class="word">${d.word || ''} (${d.pos || ''})</div>
                         <div>${d.simple_def || ''}</div>`;
        defsWrap.appendChild(div);
      });

      const synsWrap = entry.querySelector('.syns');
      (card.synonyms || []).forEach(s => {
        const div = document.createElement('div');
        div.className = 'synItem';
        const list = (s.list || []).join(', ');
        div.innerHTML = `<div class="word">${s.word || ''} (${s.pos || ''})</div>
                         <div>${list}</div>`;
        synsWrap.appendChild(div);
      });

      feed.prepend(entry);
      const max = 20;
      while (feed.children.length > max) feed.removeChild(feed.lastChild);
    }

    document.addEventListener('DOMContentLoaded', () => {
      micBtn.disabled = false;
      tabBtn.disabled = false;
      micBtn.onclick = startMic;
      tabBtn.onclick = startTabCapture;
      stopBtn.onclick = stopAll;

      // Quick test
      document.getElementById('sendManual').onclick = async () => {
        const t = document.getElementById('manualText').value.trim();
        if (!t) return;
        fullText = fullText ? (fullText + ' ' + t) : t;
        out.textContent = fullText;
        lastSentTail = tail(fullText, 20);
        try {
          const resp = await fetch('/api/hints', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ text: fullText })
          });
          const data = await resp.json();
          if (data && data.card) prependCard(data.card);
        } catch(e){ console.warn(e); }
        scheduleClearAfterPause();
      };
    });
  </script>
</body>
</html>
